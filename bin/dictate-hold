#!/home/bw/.local/share/dictation-venv/bin/python3
"""Hold-to-dictate: hold Pause to record, release to transcribe and type."""

import os
import signal
import socket
import subprocess
import sys
import time

from evdev import InputDevice, ecodes, categorize

KBD_DEVICE = "/dev/input/by-id/usb-ZSA_Technology_Labs_Planck_EZ_Glow_V7NGd_LvW0bX-event-kbd"
SOCKET_PATH = "/tmp/dictation.sock"
WAVFILE = "/tmp/dictate-audio.wav"
KEY = ecodes.KEY_PAUSE  # 119


def notify(msg, ms=1000):
    subprocess.Popen(["notify-send", "-t", str(ms), "Dictation", msg],
                     stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)


def polybar_state(hook):
    """Signal polybar dictation module. 0=off, 1=idle, 2=recording"""
    subprocess.Popen(["polybar-msg", "action", "dictation", "hook", str(hook)],
                     stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)


def start_recording():
    try:
        os.unlink(WAVFILE)
    except FileNotFoundError:
        pass
    proc = subprocess.Popen(
        ["pw-record", "--rate", "16000", "--channels", "1", "--format", "s16", WAVFILE],
        stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL,
    )
    return proc


def stop_and_transcribe(rec_proc):
    rec_proc.terminate()
    rec_proc.wait(timeout=2)
    time.sleep(0.1)

    try:
        sz = os.path.getsize(WAVFILE)
    except OSError:
        sz = 0

    if sz < 1000:
        notify("Too short")
        polybar_state(1)
        return

    if not os.path.exists(SOCKET_PATH):
        notify("Daemon not running")
        polybar_state(1)
        return

    polybar_state(1)  # Signal polybar: idle
    sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
    try:
        sock.connect(SOCKET_PATH)
        sock.sendall(WAVFILE.encode())
        sock.shutdown(socket.SHUT_WR)
        text = sock.recv(65536).decode().strip()
    except Exception as e:
        notify(f"Error: {e}")
        polybar_state(1)
        return
    finally:
        sock.close()
        try:
            os.unlink(WAVFILE)
        except OSError:
            pass

    if not text:
        notify("No speech detected")
        polybar_state(1)
        return

    subprocess.run(["xdotool", "type", "--clearmodifiers", "--", text],
                   stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)


def main():
    dev = InputDevice(KBD_DEVICE)
    rec_proc = None

    def cleanup(signum, frame):
        nonlocal rec_proc
        if rec_proc and rec_proc.poll() is None:
            rec_proc.terminate()
        sys.exit(0)

    signal.signal(signal.SIGTERM, cleanup)
    signal.signal(signal.SIGINT, cleanup)

    polybar_state(1)  # Signal polybar: service running, idle

    for event in dev.read_loop():
        if event.type != ecodes.EV_KEY:
            continue
        key_event = categorize(event)
        if key_event.scancode != KEY:
            continue

        if key_event.keystate == key_event.key_down:
            if rec_proc and rec_proc.poll() is None:
                continue  # already recording
            polybar_state(2)  # Signal polybar: recording
            rec_proc = start_recording()

        elif key_event.keystate == key_event.key_up:
            if rec_proc and rec_proc.poll() is None:
                stop_and_transcribe(rec_proc)
                rec_proc = None


if __name__ == "__main__":
    main()
