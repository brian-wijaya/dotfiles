<section id="managing-windows-hosts-with-ansible"> <h1 id="working-with-windows">Managing Windows hosts with Ansible</h1> <p>Managing Windows hosts is different from managing POSIX hosts. If you have managed nodes running Windows, review these topics.</p>  <ul class="simple"> <li><a class="reference internal" href="#bootstrapping-windows" id="id1">Bootstrapping Windows</a></li> <li>
<p><a class="reference internal" href="#connecting-to-windows-nodes" id="id2">Connecting to Windows nodes</a></p> <ul> <li><a class="reference internal" href="#psrp-and-winrm" id="id3">PSRP and WinRM</a></li> <li><a class="reference internal" href="#ssh" id="id4">SSH</a></li> </ul> </li> <li><a class="reference internal" href="#which-modules-are-available" id="id5">Which modules are available?</a></li> <li><a class="reference internal" href="#using-windows-as-the-control-node" id="id6">Using Windows as the control node</a></li> <li><a class="reference internal" href="#windows-facts" id="id7">Windows facts</a></li> <li>
<p><a class="reference internal" href="#common-windows-problems" id="id8">Common Windows problems</a></p> <ul> <li><a class="reference internal" href="#command-works-locally-but-not-under-ansible" id="id9">Command works locally but not under Ansible</a></li> <li><a class="reference internal" href="#credentials-are-rejected" id="id10">Credentials are rejected</a></li> </ul> </li> </ul>  <p>This is an index of all the topics covered in this guide.</p>  <ul> <li class="toctree-l1"><a class="reference internal" href="windows_dsc">Desired State Configuration</a></li> <li class="toctree-l1"><a class="reference internal" href="windows_performance">Windows performance</a></li> <li class="toctree-l1"><a class="reference internal" href="windows_ssh">Windows SSH</a></li> <li class="toctree-l1"><a class="reference internal" href="windows_usage">Using Ansible and Windows</a></li> <li class="toctree-l1"><a class="reference internal" href="windows_winrm">Windows Remote Management</a></li> <li class="toctree-l1"><a class="reference internal" href="windows_winrm_certificate">WinRM Certificate Authentication</a></li> <li class="toctree-l1"><a class="reference internal" href="windows_winrm_kerberos">Kerberos Authentication</a></li> </ul>  <section id="bootstrapping-windows"> <h2>Bootstrapping Windows</h2> <p>Windows nodes must be running Windows Server 2016 or Windows 10 or newer. As these versions of Windows ship with PowerShell 5.1 by default there are no additional requirements to bootstrap a Windows node.</p> <p>Support for each Windows version is tied to the extended support lifecycle of each operating system, which is typically 10 years from the date of release. Ansible is tested against the server variants of Windows but should still be compatible with the desktop variants like Windows 10 and 11.</p> </section> <section id="connecting-to-windows-nodes"> <h2>Connecting to Windows nodes</h2> <p>Ansible connects to POSIX managed nodes using OpenSSH by default. Windows nodes can also use SSH but historically they use WinRM as the connection transport. The supported connection plugins that can be used with Windows nodes are:</p> <ul class="simple"> <li>PowerShell Remoting over WinRM - <a class="reference internal" href="../collections/ansible/builtin/psrp_connection#psrp-connection"><span class="std std-ref">psrp</span></a>
</li> <li>SSH - <a class="reference internal" href="../collections/ansible/builtin/ssh_connection#ssh-connection"><span class="std std-ref">ssh</span></a>
</li> <li>Windows Remote Management - <a class="reference internal" href="../collections/ansible/builtin/winrm_connection#winrm-connection"><span class="std std-ref">winrm</span></a>
</li> </ul> <section id="psrp-and-winrm"> <h3>PSRP and WinRM</h3> <p>Historically Ansible used Windows Remote Management (<code>WinRM</code>) as the connection protocol to manage Windows nodes. The <code>psrp</code> and <code>winrm</code> connection plugins both operate over WinRM and can be used as the connection plugin for Windows nodes. The <code>psrp</code> connection plugin is a newer connection plugin that offers a few benefits over the <code>winrm</code> connection plugin, for example:</p> <ul class="simple"> <li>Can be slightly faster</li> <li>Less susceptible to timeout issues when the Windows node is under load</li> <li>Better support for proxy servers</li> </ul> <p>See <a class="reference internal" href="windows_winrm#windows-winrm"><span class="std std-ref">Windows Remote Management</span></a> for more information on how WinRM is configured and how to use the <code>psrp</code> and <code>winrm</code> connection plugins in Ansible.</p> </section> <section id="ssh"> <h3>SSH</h3> <p>SSH is the traditional connection plugin used with POSIX nodes but it can also be used to manage Windows nodes instead of the traditional <code>psrp</code> or <code>winrm</code> connection plugins.</p> <div class="admonition note"> <p class="admonition-title">Note</p> <p>While Ansible has supported using the SSH connection plugin with Windows nodes since Ansible 2.8, official support was only added in version 2.18.</p> </div> <p>Some of the benefits of using SSH over the WinRM based transports are:</p> <ul class="simple"> <li>SSH can be easier to configure in non-domain environments</li> <li>SSH supports key based authentication which is simpler to manage than certificates</li> <li>SSH file transfers are faster than WinRM</li> </ul> <p>See <a class="reference internal" href="windows_ssh#windows-ssh"><span class="std std-ref">Windows SSH</span></a> for more information on how to configure SSH for Windows nodes.</p> </section> </section> <section id="which-modules-are-available"> <h2>Which modules are available?</h2> <p>The majority of the core Ansible modules are written for a combination of Unix-like machines and other generic services. As these modules are written in Python and use APIs not present on Windows they will not work.</p> <p>There are dedicated Windows modules that are written in PowerShell and are meant to be run on Windows hosts. A list of these modules can be in the <a class="reference internal" href="../collections/ansible/windows/index#plugins-in-ansible-windows"><span class="std std-ref">Ansible.Windows</span></a>, <a class="reference internal" href="../collections/community/windows/index#plugins-in-community-windows"><span class="std std-ref">Community.Windows</span></a>, <a class="reference internal" href="../collections/microsoft/ad/index#plugins-in-microsoft-ad"><span class="std std-ref">Microsoft.Ad</span></a>, <a class="reference internal" href="../collections/chocolatey/chocolatey/index#plugins-in-chocolatey-chocolatey"><span class="std std-ref">Chocolatey.Chocolatey</span></a>, and other collections.</p> <p>In addition, the following Ansible Core modules/action-plugins work with Windows:</p> <ul class="simple"> <li>add_host</li> <li>assert</li> <li>async_status</li> <li>debug</li> <li>fail</li> <li>fetch</li> <li>group_by</li> <li>include</li> <li>include_role</li> <li>include_vars</li> <li>meta</li> <li>pause</li> <li>raw</li> <li>script</li> <li>set_fact</li> <li>set_stats</li> <li>setup</li> <li>slurp</li> <li>template (also: win_template)</li> <li>wait_for_connection</li> </ul> </section> <section id="using-windows-as-the-control-node"> <h2 id="windows-control-node">Using Windows as the control node</h2> <p>Ansible cannot run on Windows as the control node due to API limitations on the platform. However, you can run Ansible on Windows using the Windows Subsystem for Linux (<code>WSL</code>) or in a container.</p> <div class="admonition note"> <p class="admonition-title">Note</p> <p>The Windows Subsystem for Linux is not supported by Ansible and should not be used for production systems.</p> </div> </section> <section id="windows-facts"> <h2>Windows facts</h2> <p>Ansible gathers facts from Windows in a similar manner to other POSIX hosts but with some differences. Some facts may be in a different format for backwards compatibility or may not be available at all.</p> <p>To see the facts that Ansible gathers from Windows hosts, run the <code>setup</code> module.</p> <pre data-language="bash">ansible windows -m setup
</pre> </section> <section id="common-windows-problems"> <h2>Common Windows problems</h2> <section id="command-works-locally-but-not-under-ansible"> <h3>Command works locally but not under Ansible</h3> <p>Ansible executes commands through a network logon which can change how Windows authorizes actions. This can cause commands that work locally to fail under Ansible. Some examples of these failures are:</p> <ul class="simple"> <li>the process cannot delegate the user’s credentials to a network resource, causing <code>Access is  Denied</code> or <code>Resource Unavailable</code> errors</li> <li>applications that require an interactive session will not work</li> <li>some Windows APIs are restricted when running through a network logon</li> <li>some tasks require access to the <code>DPAPI</code> secrets store which is typically not available on a network logon</li> </ul> <p>The common way is to use <a class="reference internal" href="../playbook_guide/playbooks_privilege_escalation#become"><span class="std std-ref">Understanding privilege escalation: become</span></a> to run a command with explicit credentials. Using <code>become</code> on Windows will change the network logon to an interactive one and, if explicit credentials are provided to the become identity, the command will be able to access network resources and unlock the <code>DPAPI</code> store.</p> <p>Another option is to use an authentication option on the connection plugin that allows for credential delegation. For SSH this can be done with an explicit username and password or through a Kerberos/GSSAPI logon with delegation enabled. For WinRM based connections, the CredSSP or Kerberos with delegation can be used. See the connection specific documentation for more information.</p> </section> <section id="credentials-are-rejected"> <h3>Credentials are rejected</h3> <p>There are a few reasons why credentials might be rejected when connecting to the Windows host. Some common reasons are:</p> <ul class="simple"> <li>the username or password is incorrect</li> <li>the user account is locked out, disabled, not allowed to log onto that server</li> <li>the user account is not allowed to log on through the network</li> <li>the user account is not a member of the local Administrators group</li> <li>the user account is a local user and the <code>LocalAccountTokenFilterPolicy</code> is not set</li> </ul> <p>To verify whether the credentials are correct or the user is allowed to log onto the host you can run the below PowerShell command on the Windows host to see the last failed logon attempt. This will output event details including the <code>Status</code> and <code>Sub Status</code> error code indicating why the logon failed.</p> <pre data-language="powershell">Get-WinEvent -FilterHashtable @{LogName = 'Security'; Id = 4625} |
    Select-Object -First 1 -ExpandProperty Message
</pre> <p>While not all connection plugins require the connection user to be a member of the local Administrators group, this is typically the default configuration. If the user is not a member of the local Administrators group or is a local user without <code>LocalAccountTokenFilterPolicy</code> set, the authentication will fail.</p> <div class="admonition seealso"> <p class="admonition-title">See also</p> <dl class="simple"> <dt><a class="reference internal" href="../command_guide/intro_adhoc#intro-adhoc"><span class="std std-ref">Introduction to ad hoc commands</span></a></dt>
<dd>
<p>Examples of basic commands</p> </dd> <dt><a class="reference internal" href="../playbook_guide/playbooks#working-with-playbooks"><span class="std std-ref">Working with playbooks</span></a></dt>
<dd>
<p>Learning Ansible’s configuration management language</p> </dd> <dt><a class="reference internal" href="https://docs.ansible.com/ansible/latest/dev_guide/developing_modules.html#developing-modules"><span class="std std-ref">Should you develop a module?</span></a></dt>
<dd>
<p>How to write modules</p> </dd> <dt><a class="reference internal" href="windows_dsc#windows-dsc"><span class="std std-ref">Desired State Configuration</span></a></dt>
<dd>
<p>Using Ansible with Windows Desired State Configuration</p> </dd> <dt><a class="reference internal" href="windows_performance#windows-performance"><span class="std std-ref">Windows performance</span></a></dt>
<dd>
<p>Performance considerations for managing Windows hosts</p> </dd> <dt><a class="reference internal" href="windows_usage#windows-usage"><span class="std std-ref">Using Ansible and Windows</span></a></dt>
<dd>
<p>Windows usage guide</p> </dd> <dt><a class="reference external" href="https://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>
<p>Questions? Help? Ideas? Stop by the list on Google Groups</p> </dd> <dt><a class="reference internal" href="https://docs.ansible.com/ansible/latest/community/communication.html#communication-irc"><span class="std std-ref">Real-time chat</span></a></dt>
<dd>
<p>How to join Ansible chat channels</p> </dd> </dl> </div> </section> </section> </section><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2012&ndash;2018 Michael DeHaan<br>&copy; 2018&ndash;2025 Red Hat, Inc.<br>Licensed under the GNU General Public License version 3.<br>
    <a href="https://docs.ansible.com/ansible/latest/os_guide/intro_windows.html" class="_attribution-link">https://docs.ansible.com/ansible/latest/os_guide/intro_windows.html</a>
  </p>
</div>
