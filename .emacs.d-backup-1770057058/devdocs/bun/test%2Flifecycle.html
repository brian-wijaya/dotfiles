<h1 id="header">Lifecycle hooks</h1>
<div data-page-title="Lifecycle hooks" data-page-href="/test/lifecycle" id="content">
<span data-as="p">The test runner supports the following lifecycle hooks. This is useful for loading test fixtures, mocking data, and configuring the test environment.</span> <div data-table-wrapper="true"><div><table> <thead><tr>
<th>Hook</th>
<th>Description</th>
</tr></thead> <tbody>
<tr>
<td><code>beforeAll</code></td>
<td>Runs once before all tests.</td>
</tr>
<tr>
<td><code>beforeEach</code></td>
<td>Runs before each test.</td>
</tr>
<tr>
<td><code>afterEach</code></td>
<td>Runs after each test.</td>
</tr>
<tr>
<td><code>afterAll</code></td>
<td>Runs once after all tests.</td>
</tr>
<tr>
<td><code>onTestFinished</code></td>
<td>Runs after a single test finishes (after all <code>afterEach</code>).</td>
</tr>
</tbody> </table></div></div> <h2 id="per-test-setup-and-teardown"><span>Per-Test Setup and Teardown</span></h2> <span data-as="p">Perform per-test setup and teardown logic with <code>beforeEach</code> and <code>afterEach</code>.</span> <pre numberoflines="15" language="typescript" data-language="typescript">import { beforeEach, afterEach, test } from "bun:test";

beforeEach(() =&gt; {
  console.log("running test.");
});

afterEach(() =&gt; {
  console.log("done with test.");
});

// tests...
test("example test", () =&gt; {
  // This test will have beforeEach run before it
  // and afterEach run after it
});
</pre> <h2 id="per-scope-setup-and-teardown"><span>Per-Scope Setup and Teardown</span></h2> <span data-as="p">Perform per-scope setup and teardown logic with <code>beforeAll</code> and <code>afterAll</code>. The scope is determined by where the hook is defined.</span> <h3 id="scoped-to-a-describe-block"><span>Scoped to a Describe Block</span></h3> <span data-as="p">To scope the hooks to a particular describe block:</span> <pre numberoflines="21" language="typescript" data-language="typescript">import { describe, beforeAll, afterAll, test } from "bun:test";

describe("test group", () =&gt; {
  beforeAll(() =&gt; {
    // setup for this describe block
    console.log("Setting up test group");
  });

  afterAll(() =&gt; {
    // teardown for this describe block
    console.log("Tearing down test group");
  });

  test("test 1", () =&gt; {
    // test implementation
  });

  test("test 2", () =&gt; {
    // test implementation
  });
});
</pre> <h3 id="scoped-to-a-test-file"><span>Scoped to a Test File</span></h3> <span data-as="p">To scope the hooks to an entire test file:</span> <pre numberoflines="17" language="typescript" data-language="typescript">import { describe, beforeAll, afterAll, test } from "bun:test";

beforeAll(() =&gt; {
  // setup for entire file
  console.log("Setting up test file");
});

afterAll(() =&gt; {
  // teardown for entire file
  console.log("Tearing down test file");
});

describe("test group", () =&gt; {
  test("test 1", () =&gt; {
    // test implementation
  });
});
</pre> <h3 id="ontestfinished"><span><code>onTestFinished</code></span></h3> <span data-as="p">Use <code>onTestFinished</code> to run a callback after a single test completes. It runs after all <code>afterEach</code> hooks.</span> <pre numberoflines="8" language="typescript" data-language="typescript">import { test, onTestFinished } from "bun:test";

test("cleanup after test", () =&gt; {
  onTestFinished(() =&gt; {
    // runs after all afterEach hooks
    console.log("test finished");
  });
});
</pre> <span data-as="p">Not supported in concurrent tests; use <code>test.serial</code> instead.</span> <h2 id="global-setup-and-teardown"><span>Global Setup and Teardown</span></h2> <span data-as="p">To scope the hooks to an entire multi-file test run, define the hooks in a separate file.</span> <pre numberoflines="13" language="typescript" data-language="typescript">import { beforeAll, afterAll } from "bun:test";

beforeAll(() =&gt; {
  // global setup
  console.log("Global test setup");
  // Initialize database connections, start servers, etc.
});

afterAll(() =&gt; {
  // global teardown
  console.log("Global test teardown");
  // Close database connections, stop servers, etc.
});
</pre> <span data-as="p">Then use <code>--preload</code> to run the setup script before any test files.</span> <pre numberoflines="1" language="shellscript" data-language="typescript">bun test --preload ./setup.ts
</pre> <span data-as="p">To avoid typing <code>--preload</code> every time you run tests, it can be added to your <code>bunfig.toml</code>:</span> <pre numberoflines="2" language="toml" data-language="typescript">[test]
preload = ["./setup.ts"]
</pre> <h2 id="practical-examples"><span>Practical Examples</span></h2> <h3 id="database-setup"><span>Database Setup</span></h3> <pre numberoflines="22" language="typescript" data-language="typescript">import { beforeAll, afterAll, beforeEach, afterEach } from "bun:test";
import { createConnection, closeConnection, clearDatabase } from "./db";

let connection;

beforeAll(async () =&gt; {
  // Connect to test database
  connection = await createConnection({
    host: "localhost",
    database: "test_db",
  });
});

afterAll(async () =&gt; {
  // Close database connection
  await closeConnection(connection);
});

beforeEach(async () =&gt; {
  // Start with clean database for each test
  await clearDatabase(connection);
});
</pre> <h3 id="api-server-setup"><span>API Server Setup</span></h3> <pre numberoflines="17" language="typescript" data-language="typescript">import { beforeAll, afterAll } from "bun:test";
import { startServer, stopServer } from "./server";

let server;

beforeAll(async () =&gt; {
  // Start test server
  server = await startServer({
    port: 3001,
    env: "test",
  });
});

afterAll(async () =&gt; {
  // Stop test server
  await stopServer(server);
});
</pre> <h3 id="mock-setup"><span>Mock Setup</span></h3> <pre numberoflines="15" language="typescript" data-language="typescript">import { beforeEach, afterEach } from "bun:test";
import { mock } from "bun:test";

beforeEach(() =&gt; {
  // Set up common mocks
  mock.module("./api-client", () =&gt; ({
    fetchUser: mock(() =&gt; Promise.resolve({ id: 1, name: "Test User" })),
    createUser: mock(() =&gt; Promise.resolve({ id: 2 })),
  }));
});

afterEach(() =&gt; {
  // Clear all mocks after each test
  mock.restore();
});
</pre> <h2 id="async-lifecycle-hooks"><span>Async Lifecycle Hooks</span></h2> <span data-as="p">All lifecycle hooks support async functions:</span> <pre numberoflines="18" language="typescript" data-language="typescript">import { beforeAll, afterAll, test } from "bun:test";

beforeAll(async () =&gt; {
  // Async setup
  await new Promise(resolve =&gt; setTimeout(resolve, 100));
  console.log("Async setup complete");
});

afterAll(async () =&gt; {
  // Async teardown
  await new Promise(resolve =&gt; setTimeout(resolve, 100));
  console.log("Async teardown complete");
});

test("async test", async () =&gt; {
  // Test will wait for beforeAll to complete
  await expect(Promise.resolve("test")).resolves.toBe("test");
});
</pre> <h2 id="nested-hooks"><span>Nested Hooks</span></h2> <span data-as="p">Hooks can be nested and will run in the appropriate order:</span> <pre numberoflines="22" language="typescript" data-language="typescript">import { describe, beforeAll, beforeEach, afterEach, afterAll, test } from "bun:test";

beforeAll(() =&gt; console.log("File beforeAll"));
afterAll(() =&gt; console.log("File afterAll"));

describe("outer describe", () =&gt; {
  beforeAll(() =&gt; console.log("Outer beforeAll"));
  beforeEach(() =&gt; console.log("Outer beforeEach"));
  afterEach(() =&gt; console.log("Outer afterEach"));
  afterAll(() =&gt; console.log("Outer afterAll"));

  describe("inner describe", () =&gt; {
    beforeAll(() =&gt; console.log("Inner beforeAll"));
    beforeEach(() =&gt; console.log("Inner beforeEach"));
    afterEach(() =&gt; console.log("Inner afterEach"));
    afterAll(() =&gt; console.log("Inner afterAll"));

    test("nested test", () =&gt; {
      console.log("Test running");
    });
  });
});
</pre> <pre numberoflines="13" language="text" data-language="typescript">// Output order:
// File beforeAll
// Outer beforeAll
// Inner beforeAll
// Outer beforeEach
// Inner beforeEach
// Test running
// Inner afterEach
// Outer afterEach
// Inner afterAll
// Outer afterAll
// File afterAll
</pre> <h2 id="error-handling"><span>Error Handling</span></h2> <span data-as="p">If a lifecycle hook throws an error, it will affect test execution:</span> <pre numberoflines="10" language="typescript" data-language="typescript">import { beforeAll, test } from "bun:test";

beforeAll(() =&gt; {
  // If this throws, all tests in this scope will be skipped
  throw new Error("Setup failed");
});

test("this test will be skipped", () =&gt; {
  // This won't run because beforeAll failed
});
</pre> <span data-as="p">For better error handling:</span> <pre numberoflines="10" language="typescript" data-language="typescript">import { beforeAll, test, expect } from "bun:test";

beforeAll(async () =&gt; {
  try {
    await setupDatabase();
  } catch (error) {
    console.error("Database setup failed:", error);
    throw error; // Re-throw to fail the test suite
  }
});
</pre> <h2 id="best-practices"><span>Best Practices</span></h2> <h3 id="keep-hooks-simple"><span>Keep Hooks Simple</span></h3> <pre numberoflines="13" language="typescript" data-language="typescript">// Good: Simple, focused setup
beforeEach(() =&gt; {
  clearLocalStorage();
  resetMocks();
});

// Avoid: Complex logic in hooks
beforeEach(async () =&gt; {
  // Too much complex logic makes tests hard to debug
  const data = await fetchComplexData();
  await processData(data);
  await setupMultipleServices(data);
});
</pre> <h3 id="use-appropriate-scope"><span>Use Appropriate Scope</span></h3> <pre numberoflines="9" language="typescript" data-language="typescript">// Good: File-level setup for shared resources
beforeAll(async () =&gt; {
  await startTestServer();
});

// Good: Test-level setup for test-specific state
beforeEach(() =&gt; {
  user = createTestUser();
});
</pre> <h3 id="clean-up-resources"><span>Clean Up Resources</span></h3> <pre numberoflines="13" language="typescript" data-language="typescript">import { afterAll, afterEach } from "bun:test";

afterEach(() =&gt; {
  // Clean up after each test
  document.body.innerHTML = "";
  localStorage.clear();
});

afterAll(async () =&gt; {
  // Clean up expensive resources
  await closeDatabase();
  await stopServer();
});
</pre>
</div><div class="_attribution">
  <p class="_attribution-p">
    &copy; bun.com, oven-sh, Jarred Sumner<br>Licensed under the MIT License.<br>
    <a href="https://bun.com/docs/test/lifecycle" class="_attribution-link">https://bun.com/docs/test/lifecycle</a>
  </p>
</div>
