<h1 id="header">HTMLRewriter</h1>
<div data-page-title="HTMLRewriter" data-page-href="/runtime/html-rewriter" id="content">
<span data-as="p">HTMLRewriter lets you use CSS selectors to transform HTML documents. It works with <code>Request</code>, <code>Response</code>, as well as <code>string</code>. Bun’s implementation is based on Cloudflare’s <a href="https://github.com/cloudflare/lol-html" target="_blank" rel="noreferrer">lol-html</a>.</span> <hr> <h2 id="usage"><span>Usage</span></h2> <span data-as="p">A common usecase is rewriting URLs in HTML content. Here’s an example that rewrites image sources and link URLs to use a CDN domain:</span> <pre numberoflines="30" language="typescript" data-language="typescript">// Replace all images with a rickroll
const rewriter = new HTMLRewriter().on("img", {
  element(img) {
    // Famous rickroll video thumbnail
    img.setAttribute("src", "https://img.youtube.com/vi/dQw4w9WgXcQ/maxresdefault.jpg");

    // Wrap the image in a link to the video
    img.before('&lt;a href="https://www.youtube.com/watch?v=dQw4w9WgXcQ" target="_blank"&gt;', {
      html: true,
    });
    img.after("&lt;/a&gt;", { html: true });

    // Add some fun alt text
    img.setAttribute("alt", "Definitely not a rickroll");
  },
});

// An example HTML document
const html = `
&lt;html&gt;
&lt;body&gt;
  &lt;img src="/cat.jpg"&gt;
  &lt;img src="dog.png"&gt;
  &lt;img src="https://example.com/bird.webp"&gt;
&lt;/body&gt;
&lt;/html&gt;
`;

const result = rewriter.transform(html);
console.log(result);
</pre> <span data-as="p">This replaces all images with a thumbnail of Rick Astley and wraps each <code>&lt;img&gt;</code> in a link, producing a diff like this:</span> <pre numberoflines="16" language="html" data-language="typescript">&lt;html&gt;
  &lt;body&gt;
    &lt;img src="/cat.jpg" /&gt; 
    &lt;img src="dog.png" /&gt; 
    &lt;img src="https://example.com/bird.webp" /&gt; 
    &lt;a href="https://www.youtube.com/watch?v=dQw4w9WgXcQ" target="_blank"&gt; 
      &lt;img src="https://img.youtube.com/vi/dQw4w9WgXcQ/maxresdefault.jpg" alt="Definitely not a rickroll" /&gt; 
    &lt;/a&gt; 
    &lt;a href="https://www.youtube.com/watch?v=dQw4w9WgXcQ" target="_blank"&gt; 
      &lt;img src="https://img.youtube.com/vi/dQw4w9WgXcQ/maxresdefault.jpg" alt="Definitely not a rickroll" /&gt; 
    &lt;/a&gt; 
    &lt;a href="https://www.youtube.com/watch?v=dQw4w9WgXcQ" target="_blank"&gt; 
      &lt;img src="https://img.youtube.com/vi/dQw4w9WgXcQ/maxresdefault.jpg" alt="Definitely not a rickroll" /&gt; 
    &lt;/a&gt; 
  &lt;/body&gt;
&lt;/html&gt;
</pre> <span data-as="p">Now every image on the page will be replaced with a thumbnail of Rick Astley, and clicking any image will lead to <a href="https://www.youtube.com/watch?v=dQw4w9WgXcQ" target="_blank" rel="noreferrer">a very famous video</a>.</span> <h3 id="input-types"><span>Input types</span></h3> <span data-as="p">HTMLRewriter can transform HTML from various sources. The input is automatically handled based on its type:</span> <pre numberoflines="14" language="typescript" data-language="typescript">// From Response
rewriter.transform(new Response("&lt;div&gt;content&lt;/div&gt;"));

// From string
rewriter.transform("&lt;div&gt;content&lt;/div&gt;");

// From ArrayBuffer
rewriter.transform(new TextEncoder().encode("&lt;div&gt;content&lt;/div&gt;").buffer);

// From Blob
rewriter.transform(new Blob(["&lt;div&gt;content&lt;/div&gt;"]));

// From File
rewriter.transform(Bun.file("index.html"));
</pre> <span data-as="p">Note that Cloudflare Workers implementation of HTMLRewriter only supports <code>Response</code> objects.</span> <h3 id="element-handlers"><span>Element Handlers</span></h3> <span data-as="p">The <code>on(selector, handlers)</code> method allows you to register handlers for HTML elements that match a CSS selector. The handlers are called for each matching element during parsing:</span> <pre numberoflines="15" language="typescript" data-language="typescript">rewriter.on("div.content", {
  // Handle elements
  element(element) {
    element.setAttribute("class", "new-content");
    element.append("&lt;p&gt;New content&lt;/p&gt;", { html: true });
  },
  // Handle text nodes
  text(text) {
    text.replace("new text");
  },
  // Handle comments
  comments(comment) {
    comment.remove();
  },
});
</pre> <span data-as="p">The handlers can be asynchronous and return a Promise. Note that async operations will block the transformation until they complete:</span> <pre numberoflines="6" language="typescript" data-language="typescript">rewriter.on("div", {
  async element(element) {
    await Bun.sleep(1000);
    element.setInnerContent("&lt;span&gt;replace&lt;/span&gt;", { html: true });
  },
});
</pre> <h3 id="css-selector-support"><span>CSS Selector Support</span></h3> <span data-as="p">The <code>on()</code> method supports a wide range of CSS selectors:</span> <pre numberoflines="33" language="typescript" data-language="typescript">// Tag selectors
rewriter.on("p", handler);

// Class selectors
rewriter.on("p.red", handler);

// ID selectors
rewriter.on("h1#header", handler);

// Attribute selectors
rewriter.on("p[data-test]", handler); // Has attribute
rewriter.on('p[data-test="one"]', handler); // Exact match
rewriter.on('p[data-test="one" i]', handler); // Case-insensitive
rewriter.on('p[data-test="one" s]', handler); // Case-sensitive
rewriter.on('p[data-test~="two"]', handler); // Word match
rewriter.on('p[data-test^="a"]', handler); // Starts with
rewriter.on('p[data-test$="1"]', handler); // Ends with
rewriter.on('p[data-test*="b"]', handler); // Contains
rewriter.on('p[data-test|="a"]', handler); // Dash-separated

// Combinators
rewriter.on("div span", handler); // Descendant
rewriter.on("div &gt; span", handler); // Direct child

// Pseudo-classes
rewriter.on("p:nth-child(2)", handler);
rewriter.on("p:first-child", handler);
rewriter.on("p:nth-of-type(2)", handler);
rewriter.on("p:first-of-type", handler);
rewriter.on("p:not(:first-child)", handler);

// Universal selector
rewriter.on("*", handler);
</pre> <h3 id="element-operations"><span>Element Operations</span></h3> <span data-as="p">Elements provide various methods for manipulation. All modification methods return the element instance for chaining:</span> <pre numberoflines="48" language="typescript" data-language="typescript">rewriter.on("div", {
  element(el) {
    // Attributes
    el.setAttribute("class", "new-class").setAttribute("data-id", "123");

    const classAttr = el.getAttribute("class"); // "new-class"
    const hasId = el.hasAttribute("id"); // boolean
    el.removeAttribute("class");

    // Content manipulation
    el.setInnerContent("New content"); // Escapes HTML by default
    el.setInnerContent("&lt;p&gt;HTML content&lt;/p&gt;", { html: true }); // Parses HTML
    el.setInnerContent(""); // Clear content

    // Position manipulation
    el.before("Content before").after("Content after").prepend("First child").append("Last child");

    // HTML content insertion
    el.before("&lt;span&gt;before&lt;/span&gt;", { html: true })
      .after("&lt;span&gt;after&lt;/span&gt;", { html: true })
      .prepend("&lt;span&gt;first&lt;/span&gt;", { html: true })
      .append("&lt;span&gt;last&lt;/span&gt;", { html: true });

    // Removal
    el.remove(); // Remove element and contents
    el.removeAndKeepContent(); // Remove only the element tags

    // Properties
    console.log(el.tagName); // Lowercase tag name
    console.log(el.namespaceURI); // Element's namespace URI
    console.log(el.selfClosing); // Whether element is self-closing (e.g. &lt;div /&gt;)
    console.log(el.canHaveContent); // Whether element can contain content (false for void elements like &lt;br&gt;)
    console.log(el.removed); // Whether element was removed

    // Attributes iteration
    for (const [name, value] of el.attributes) {
      console.log(name, value);
    }

    // End tag handling
    el.onEndTag(endTag =&gt; {
      endTag.before("Before end tag");
      endTag.after("After end tag");
      endTag.remove(); // Remove the end tag
      console.log(endTag.name); // Tag name in lowercase
    });
  },
});
</pre> <h3 id="text-operations"><span>Text Operations</span></h3> <span data-as="p">Text handlers provide methods for text manipulation. Text chunks represent portions of text content and provide information about their position in the text node:</span> <pre numberoflines="17" language="typescript" data-language="typescript">rewriter.on("p", {
  text(text) {
    // Content
    console.log(text.text); // Text content
    console.log(text.lastInTextNode); // Whether this is the last chunk
    console.log(text.removed); // Whether text was removed

    // Manipulation
    text.before("Before text").after("After text").replace("New text").remove();

    // HTML content insertion
    text
      .before("&lt;span&gt;before&lt;/span&gt;", { html: true })
      .after("&lt;span&gt;after&lt;/span&gt;", { html: true })
      .replace("&lt;span&gt;replace&lt;/span&gt;", { html: true });
  },
});
</pre> <h3 id="comment-operations"><span>Comment Operations</span></h3> <span data-as="p">Comment handlers allow comment manipulation with similar methods to text nodes:</span> <pre numberoflines="17" language="typescript" data-language="typescript">rewriter.on("*", {
  comments(comment) {
    // Content
    console.log(comment.text); // Comment text
    comment.text = "New comment text"; // Set comment text
    console.log(comment.removed); // Whether comment was removed

    // Manipulation
    comment.before("Before comment").after("After comment").replace("New comment").remove();

    // HTML content insertion
    comment
      .before("&lt;span&gt;before&lt;/span&gt;", { html: true })
      .after("&lt;span&gt;after&lt;/span&gt;", { html: true })
      .replace("&lt;span&gt;replace&lt;/span&gt;", { html: true });
  },
});
</pre> <h3 id="document-handlers"><span>Document Handlers</span></h3> <span data-as="p">The <code>onDocument(handlers)</code> method allows you to handle document-level events. These handlers are called for events that occur at the document level rather than within specific elements:</span> <pre numberoflines="20" language="typescript" data-language="typescript">rewriter.onDocument({
  // Handle doctype
  doctype(doctype) {
    console.log(doctype.name); // "html"
    console.log(doctype.publicId); // public identifier if present
    console.log(doctype.systemId); // system identifier if present
  },
  // Handle text nodes
  text(text) {
    console.log(text.text);
  },
  // Handle comments
  comments(comment) {
    console.log(comment.text);
  },
  // Handle document end
  end(end) {
    end.append("&lt;!-- Footer --&gt;", { html: true });
  },
});
</pre> <h3 id="response-handling"><span>Response Handling</span></h3> <span data-as="p">When transforming a Response:</span> <ul> <li>The status code, headers, and other response properties are preserved</li> <li>The body is transformed while maintaining streaming capabilities</li> <li>Content-encoding (like gzip) is handled automatically</li> <li>The original response body is marked as used after transformation</li> <li>Headers are cloned to the new response</li> </ul> <h2 id="error-handling"><span>Error Handling</span></h2> <span data-as="p">HTMLRewriter operations can throw errors in several cases:</span> <ul> <li>Invalid selector syntax in <code>on()</code> method</li> <li>Invalid HTML content in transformation methods</li> <li>Stream errors when processing Response bodies</li> <li>Memory allocation failures</li> <li>Invalid input types (e.g., passing Symbol)</li> <li>Body already used errors</li> </ul> <span data-as="p">Errors should be caught and handled appropriately:</span> <pre numberoflines="6" language="typescript" data-language="typescript">try {
  const result = rewriter.transform(input);
  // Process result
} catch (error) {
  console.error("HTMLRewriter error:", error);
}
</pre> <hr> <h2 id="see-also"><span>See also</span></h2> <span data-as="p">You can also read the <a href="https://developers.cloudflare.com/workers/runtime-apis/html-rewriter/" target="_blank" rel="noreferrer">Cloudflare documentation</a>, which this API is intended to be compatible with.</span>
</div><div class="_attribution">
  <p class="_attribution-p">
    &copy; bun.com, oven-sh, Jarred Sumner<br>Licensed under the MIT License.<br>
    <a href="https://bun.com/docs/runtime/html-rewriter" class="_attribution-link">https://bun.com/docs/runtime/html-rewriter</a>
  </p>
</div>
