<h1 id="header">Set per-socket contextual data on a WebSocket</h1>
<div data-page-title="Set per-socket contextual data on a WebSocket" data-page-href="/guides/websocket/context" id="content">
<span data-as="p">When building a WebSocket server, it’s typically necessary to store some identifying information or context associated with each connected client.</span> <span data-as="p">With <a href="../../runtime/http/websockets#contextual-data">Bun.serve()</a>, this “contextual data” is set when the connection is initially upgraded by passing a <code>data</code> parameter in the <code>server.upgrade()</code> call.</span> <pre numberoflines="24" language="typescript" data-language="typescript">Bun.serve({
  fetch(req, server) {
    const success = server.upgrade(req, {
      data: {
        socketId: Math.random(),
      },
    });
    if (success) return undefined;

    // handle HTTP request normally
    // ...
  },
  websocket: {
    // TypeScript: specify the type of ws.data like this
    data: {} as { socketId: number },

    // define websocket handlers
    async message(ws, message) {
      // the contextual data is available as the `data` property
      // on the WebSocket instance
      console.log(`Received ${message} from ${ws.data.socketId}}`);
    },
  },
});
</pre> <hr> <span data-as="p">It’s common to read cookies/headers from the incoming request to identify the connecting client.</span> <pre numberoflines="36" language="typescript" data-language="typescript">type WebSocketData = {
  createdAt: number;
  token: string;
  userId: string;
};

Bun.serve({
  async fetch(req, server) {
    // use a library to parse cookies
    const cookies = parseCookies(req.headers.get("Cookie"));
    const token = cookies["X-Token"];
    const user = await getUserFromToken(token);

    const upgraded = server.upgrade(req, {
      data: {
        createdAt: Date.now(),
        token: cookies["X-Token"],
        userId: user.id,
      },
    });

    if (upgraded) return undefined;
  },
  websocket: {
    // TypeScript: specify the type of ws.data like this
    data: {} as WebSocketData,

    async message(ws, message) {
      // save the message to a database
      await saveMessageToDatabase({
        message: String(message),
        userId: ws.data.userId,
      });
    },
  },
});
</pre>
</div><div class="_attribution">
  <p class="_attribution-p">
    &copy; bun.com, oven-sh, Jarred Sumner<br>Licensed under the MIT License.<br>
    <a href="https://bun.com/docs/guides/websocket/context" class="_attribution-link">https://bun.com/docs/guides/websocket/context</a>
  </p>
</div>
