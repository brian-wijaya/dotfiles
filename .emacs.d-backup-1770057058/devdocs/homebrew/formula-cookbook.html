<h1 id="formula-cookbook">Formula Cookbook</h1> <p>A <em>formula</em> is a package definition written in Ruby. It can be created with <code class="language-plaintext highlighter-rouge">brew create &lt;URL&gt;</code> where <code class="language-plaintext highlighter-rouge">&lt;URL&gt;</code> is a zip or tarball, installed with <code class="language-plaintext highlighter-rouge">brew install &lt;formula&gt;</code>, and debugged with <code class="language-plaintext highlighter-rouge">brew install --debug --verbose &lt;formula&gt;</code>. Formulae use the <a href="https://rubydoc.brew.sh/Formula"><code class="language-plaintext highlighter-rouge">Formula</code> class API</a> which provides various Homebrew-specific helpers.</p> <ul id="markdown-toc"> <li><a href="#homebrew-terminology" id="markdown-toc-homebrew-terminology">Homebrew terminology</a></li> <li><a href="#an-introduction" id="markdown-toc-an-introduction">An introduction</a></li> <li>
<a href="#basic-instructions" id="markdown-toc-basic-instructions">Basic instructions</a> <ul> <li><a href="#grab-the-url" id="markdown-toc-grab-the-url">Grab the URL</a></li> <li><a href="#fill-in-the-homepage" id="markdown-toc-fill-in-the-homepage">Fill in the <code class="language-plaintext highlighter-rouge">homepage</code></a></li> <li><a href="#fill-in-the-license" id="markdown-toc-fill-in-the-license">Fill in the <code class="language-plaintext highlighter-rouge">license</code></a></li> <li><a href="#check-the-build-system" id="markdown-toc-check-the-build-system">Check the build system</a></li> <li><a href="#check-for-dependencies" id="markdown-toc-check-for-dependencies">Check for dependencies</a></li> <li><a href="#specifying-other-formulae-as-dependencies" id="markdown-toc-specifying-other-formulae-as-dependencies">Specifying other formulae as dependencies</a></li> <li><a href="#specifying-conflicts-with-other-formulae" id="markdown-toc-specifying-conflicts-with-other-formulae">Specifying conflicts with other formulae</a></li> <li><a href="#formulae-revisions" id="markdown-toc-formulae-revisions">Formulae revisions</a></li> <li><a href="#version-scheme-changes" id="markdown-toc-version-scheme-changes">Version scheme changes</a></li> <li><a href="#double-check-for-dependencies" id="markdown-toc-double-check-for-dependencies">Double-check for dependencies</a></li> <li><a href="#specifying-macos-components-as-dependencies" id="markdown-toc-specifying-macos-components-as-dependencies">Specifying macOS components as dependencies</a></li> <li><a href="#specifying-gems-python-modules-go-projects-etc-as-dependencies" id="markdown-toc-specifying-gems-python-modules-go-projects-etc-as-dependencies">Specifying gems, Python modules, Go projects, etc. as dependencies</a></li> <li><a href="#ruby-gem-dependencies" id="markdown-toc-ruby-gem-dependencies">Ruby Gem Dependencies</a></li> <li><a href="#python-dependencies" id="markdown-toc-python-dependencies">Python dependencies</a></li> <li><a href="#all-other-cases" id="markdown-toc-all-other-cases">All other cases</a></li> <li><a href="#install-the-formula" id="markdown-toc-install-the-formula">Install the formula</a></li> <li><a href="#add-a-test-to-the-formula" id="markdown-toc-add-a-test-to-the-formula">Add a test to the formula</a></li> <li><a href="#manuals" id="markdown-toc-manuals">Manuals</a></li> <li><a href="#caveats" id="markdown-toc-caveats">Caveats</a></li> <li><a href="#a-quick-word-on-naming" id="markdown-toc-a-quick-word-on-naming">A quick word on naming</a></li> <li><a href="#audit-the-formula" id="markdown-toc-audit-the-formula">Audit the formula</a></li> <li><a href="#commit" id="markdown-toc-commit">Commit</a></li> <li><a href="#push" id="markdown-toc-push">Push</a></li> </ul> </li> <li>
<a href="#convenience-tools" id="markdown-toc-convenience-tools">Convenience tools</a> <ul> <li><a href="#messaging" id="markdown-toc-messaging">Messaging</a></li> <li><a href="#standard-arguments" id="markdown-toc-standard-arguments">Standard arguments</a></li> <li><a href="#bininstall-foo" id="markdown-toc-bininstall-foo"><code class="language-plaintext highlighter-rouge">bin.install "foo"</code></a></li> <li><a href="#inreplace" id="markdown-toc-inreplace"><code class="language-plaintext highlighter-rouge">inreplace</code></a></li> </ul> </li> <li>
<a href="#patches" id="markdown-toc-patches">Patches</a> <ul> <li><a href="#creating-the-diff" id="markdown-toc-creating-the-diff">Creating the diff</a></li> </ul> </li> <li>
<a href="#advanced-formula-tricks" id="markdown-toc-advanced-formula-tricks">Advanced formula tricks</a> <ul> <li><a href="#handling-different-system-configurations" id="markdown-toc-handling-different-system-configurations">Handling different system configurations</a></li> <li><a href="#livecheck-blocks" id="markdown-toc-livecheck-blocks"><code class="language-plaintext highlighter-rouge">livecheck</code> blocks</a></li> <li><a href="#excluding-formula-from-autobumping" id="markdown-toc-excluding-formula-from-autobumping">Excluding formula from autobumping</a></li> <li><a href="#url-download-strategies" id="markdown-toc-url-download-strategies">URL download strategies</a></li> <li><a href="#unstable-versions-head" id="markdown-toc-unstable-versions-head">Unstable versions (<code class="language-plaintext highlighter-rouge">head</code>)</a></li> <li><a href="#compiler-selection" id="markdown-toc-compiler-selection">Compiler selection</a></li> <li><a href="#just-moving-some-files" id="markdown-toc-just-moving-some-files">Just moving some files</a></li> <li><a href="#file-level-operations" id="markdown-toc-file-level-operations">File-level operations</a></li> <li><a href="#rewriting-a-script-shebang" id="markdown-toc-rewriting-a-script-shebang">Rewriting a script shebang</a></li> <li><a href="#adding-optional-steps" id="markdown-toc-adding-optional-steps">Adding optional steps</a></li> <li><a href="#running-commands-after-installation" id="markdown-toc-running-commands-after-installation">Running commands after installation</a></li> <li><a href="#handling-files-that-should-persist-over-formula-upgrades" id="markdown-toc-handling-files-that-should-persist-over-formula-upgrades">Handling files that should persist over formula upgrades</a></li> <li><a href="#service-files" id="markdown-toc-service-files">Service files</a></li> <li><a href="#using-environment-variables" id="markdown-toc-using-environment-variables">Using environment variables</a></li> <li><a href="#deprecating-and-disabling-a-formula" id="markdown-toc-deprecating-and-disabling-a-formula">Deprecating and disabling a formula</a></li> </ul> </li> <li><a href="#updating-formulae" id="markdown-toc-updating-formulae">Updating formulae</a></li> <li>
<a href="#troubleshooting-for-new-formulae" id="markdown-toc-troubleshooting-for-new-formulae">Troubleshooting for new formulae</a> <ul> <li><a href="#version-detection-failures" id="markdown-toc-version-detection-failures">Version detection failures</a></li> <li><a href="#bad-makefiles" id="markdown-toc-bad-makefiles">Bad makefiles</a></li> <li><a href="#still-wont-work" id="markdown-toc-still-wont-work">Still won‚Äôt work?</a></li> <li><a href="#superenv-notes" id="markdown-toc-superenv-notes">Superenv notes</a></li> <li><a href="#fortran" id="markdown-toc-fortran">Fortran</a></li> <li><a href="#mpi" id="markdown-toc-mpi">MPI</a></li> <li><a href="#linear-algebra-libraries" id="markdown-toc-linear-algebra-libraries">Linear algebra libraries</a></li> </ul> </li> <li><a href="#how-to-start-over-reset-to-upstream" id="markdown-toc-how-to-start-over-reset-to-upstream">How to start over (reset to upstream)</a></li> </ul> <h2 id="homebrew-terminology">Homebrew terminology</h2> <table> <thead> <tr> <th>term</th> <th>description</th> <th>example</th> </tr> </thead> <tbody> <tr> <td><strong>formula</strong></td> <td>Homebrew package definition that builds from upstream sources</td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/Library/Taps/homebrew/homebrew-core/Formula/f/foo.rb</code></td> </tr> <tr> <td><strong>cask</strong></td> <td>Homebrew package definition that installs pre-compiled binaries built and signed by upstream</td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/Library/Taps/homebrew/homebrew-cask/Casks/b/bar.rb</code></td> </tr> <tr> <td><strong>prefix</strong></td> <td>path in which Homebrew is installed</td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew</code></td> </tr> <tr> <td><strong>keg</strong></td> <td>installation destination directory of a given <strong>formula</strong> version</td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/Cellar/foo/0.1</code></td> </tr> <tr> <td><strong>rack</strong></td> <td>directory containing one or more versioned <strong>kegs</strong>
</td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/Cellar/foo</code></td> </tr> <tr> <td><strong>keg-only</strong></td> <td>a <strong>formula</strong> is <em>keg-only</em> if it is not symlinked into Homebrew‚Äôs prefix</td> <td>the <a href="https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/o/openjdk.rb"><code class="language-plaintext highlighter-rouge">openjdk</code></a> formula</td> </tr> <tr> <td><strong>opt prefix</strong></td> <td>a symlink to the active version of a <strong>keg</strong>
</td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/opt/foo</code></td> </tr> <tr> <td><strong>Cellar</strong></td> <td>directory containing one or more named <strong>racks</strong>
</td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/Cellar</code></td> </tr> <tr> <td><strong>Caskroom</strong></td> <td>directory containing one or more named <strong>casks</strong>
</td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/Caskroom</code></td> </tr> <tr> <td><strong>external command</strong></td> <td>
<code class="language-plaintext highlighter-rouge">brew</code> subcommand defined outside of the Homebrew/brew GitHub repository</td> <td><a href="https://github.com/Homebrew/homebrew-test-bot"><code class="language-plaintext highlighter-rouge">brew test-bot</code></a></td> </tr> <tr> <td><strong>tap</strong></td> <td>directory (and usually Git repository) of <strong>formulae</strong>, <strong>casks</strong> and/or <strong>external commands</strong>
</td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/Library/Taps/homebrew/homebrew-core</code></td> </tr> <tr> <td><strong>bottle</strong></td> <td>pre-built <strong>keg</strong> poured into a <strong>rack</strong> of the <strong>Cellar</strong> instead of building from upstream sources</td> <td><code class="language-plaintext highlighter-rouge">qt--6.5.1.ventura.bottle.tar.gz</code></td> </tr> <tr> <td><strong>tab</strong></td> <td>information about a <strong>keg</strong>, e.g. whether it was poured from a <strong>bottle</strong> or built from source</td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/Cellar/foo/0.1/INSTALL_RECEIPT.json</code></td> </tr> <tr> <td><strong>Brew Bundle</strong></td> <td>a declarative interface to Homebrew</td> <td><code class="language-plaintext highlighter-rouge">brew 'myservice', restart_service: true</code></td> </tr> <tr> <td><strong>Brew Services</strong></td> <td>the Homebrew command to manage background services</td> <td><code class="language-plaintext highlighter-rouge">brew services start myservice</code></td> </tr> </tbody> </table> <h2 id="an-introduction">An introduction</h2> <p>Homebrew uses Git for storing formulae and contributing to the project.</p> <p>As of <a href="https://brew.sh/2023/02/16/homebrew-4.0.0/">Homebrew 4.0.0</a>, formulae are downloaded as JSON from <a href="https://formulae.brew.sh">https://formulae.brew.sh</a> which is automatically regenerated by a scheduled <a href="https://github.com/Homebrew/formulae.brew.sh">Homebrew/formulae.brew.sh</a> job from the default branch of the Homebrew/homebrew-core repository.</p> <p>Homebrew installs formulae to the Cellar at <code class="language-plaintext highlighter-rouge">$(brew --cellar)</code> and then symlinks some of the installation into the prefix at <code class="language-plaintext highlighter-rouge">$(brew --prefix)</code> (e.g. <code class="language-plaintext highlighter-rouge">/opt/homebrew</code>) so that other programs can see what‚Äôs going on. We suggest running <code class="language-plaintext highlighter-rouge">brew ls</code> on a few of the kegs in your Cellar to see how it is all arranged.</p> <p>Packages are installed according to their formulae. Read over a simple one, e.g. <code class="language-plaintext highlighter-rouge">brew edit etl</code> (or <a href="https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/e/etl.rb">etl.rb</a>) or a more advanced one, e.g. <code class="language-plaintext highlighter-rouge">brew edit git</code> (or <a href="https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/g/git.rb">git.rb</a>).</p> <h2 id="basic-instructions">Basic instructions</h2> <p>Make sure you run <code class="language-plaintext highlighter-rouge">brew update</code> before you start. This ensures your Homebrew installation is a Git repository.</p> <p>To create or edit formulae locally, you‚Äôll need to first <a href="faq#can-i-edit-formulae-myself">tap <code class="language-plaintext highlighter-rouge">homebrew/core</code></a> if you haven‚Äôt previously. This clones the Homebrew/homebrew-core Git repository to <code class="language-plaintext highlighter-rouge">$(brew --repository homebrew/core)</code>. As you‚Äôre developing, you‚Äôll also need to set <code class="language-plaintext highlighter-rouge">HOMEBREW_NO_INSTALL_FROM_API=1</code> in your shell environment or before any <code class="language-plaintext highlighter-rouge">install</code>, <code class="language-plaintext highlighter-rouge">reinstall</code> or <code class="language-plaintext highlighter-rouge">upgrade</code> commands to force <code class="language-plaintext highlighter-rouge">brew</code> to use the local repository instead of the API.</p> <p>Before submitting a new formula make sure your package:</p> <ul> <li>meets all our <a href="acceptable-formulae">Acceptable Formulae</a> requirements</li> <li>isn‚Äôt already in Homebrew (check <code class="language-plaintext highlighter-rouge">brew search &lt;formula&gt;</code>)</li> <li>isn‚Äôt already waiting to be merged (check the <a href="https://github.com/Homebrew/homebrew-core/pulls">issue tracker</a>)</li> <li>is still supported by upstream (i.e. doesn‚Äôt require extensive patching)</li> <li>has a stable, tagged version (i.e. isn‚Äôt just a GitHub repository with no versions)</li> <li>passes all <code class="language-plaintext highlighter-rouge">brew audit --new --formula &lt;formula&gt;</code> tests</li> </ul> <p>Before submitting a new formula make sure you read over our <a href="https://github.com/Homebrew/brew/blob/HEAD/CONTRIBUTING.md#contributing-to-homebrew">contribution guidelines</a>.</p> <h3 id="grab-the-url">Grab the URL</h3> <p>Run <code class="language-plaintext highlighter-rouge">brew create</code> with a URL to the source tarball:</p> <pre data-language="bash">brew create https://example.com/foo-0.1.tar.gz</pre> <p>This creates <code class="language-plaintext highlighter-rouge">$(brew --repository)/Library/Taps/homebrew/homebrew-core/Formula/f/foo.rb</code> and opens it in your <code class="language-plaintext highlighter-rouge">EDITOR</code>.</p> <p>Passing in <code class="language-plaintext highlighter-rouge">--ruby</code> or <code class="language-plaintext highlighter-rouge">--python</code> will populate various defaults commonly useful for projects written in those languages.</p> <p>If <code class="language-plaintext highlighter-rouge">brew</code> said <code class="language-plaintext highlighter-rouge">Warning: Version cannot be determined from URL</code> when doing the <code class="language-plaintext highlighter-rouge">create</code> step, you‚Äôll need to explicitly add the correct <a href="https://rubydoc.brew.sh/Formula#version-class_method"><code class="language-plaintext highlighter-rouge">version</code></a> to the formula and then save the formula.</p> <p>Homebrew will try to guess the formula‚Äôs name from its URL. If it fails to do so you can override this with <code class="language-plaintext highlighter-rouge">brew create &lt;URL&gt; --set-name &lt;name&gt;</code>.</p> <h3 id="fill-in-the-homepage">Fill in the <code class="language-plaintext highlighter-rouge">homepage</code>
</h3> <p><strong>We don‚Äôt accept formulae without a <a href="https://rubydoc.brew.sh/Formula#homepage-class_method"><code class="language-plaintext highlighter-rouge">homepage</code></a>!</strong></p> <p>An SSL/TLS (https) <a href="https://rubydoc.brew.sh/Formula#homepage-class_method"><code class="language-plaintext highlighter-rouge">homepage</code></a> is preferred, if one is available.</p> <p>Try to summarise from the <a href="https://rubydoc.brew.sh/Formula#homepage-class_method"><code class="language-plaintext highlighter-rouge">homepage</code></a> what the formula does in the <a href="https://rubydoc.brew.sh/Formula#desc-class_method"><code class="language-plaintext highlighter-rouge">desc</code></a>ription. Note that the <a href="https://rubydoc.brew.sh/Formula#desc-class_method"><code class="language-plaintext highlighter-rouge">desc</code></a>ription is automatically prepended with the formula name when printed.</p> <h3 id="fill-in-the-license">Fill in the <code class="language-plaintext highlighter-rouge">license</code>
</h3> <p><strong>We don‚Äôt accept new formulae into Homebrew/homebrew-core without a <a href="https://rubydoc.brew.sh/Formula#license-class_method"><code class="language-plaintext highlighter-rouge">license</code></a>!</strong></p> <p>We only accept formulae that use a <a href="https://wiki.debian.org/DFSGLicenses">Debian Free Software Guidelines license</a> or are released into the public domain following <a href="https://wiki.debian.org/DFSGLicenses#Public_Domain">DFSG Guidelines on Public Domain software</a>.</p> <p>Use the license identifier from the <a href="https://spdx.org/licenses/">SPDX License List</a> e.g. <code class="language-plaintext highlighter-rouge">license "BSD-2-Clause"</code>, or use <code class="language-plaintext highlighter-rouge">license :public_domain</code> for public domain software.</p> <p>Use <code class="language-plaintext highlighter-rouge">:any_of</code>, <code class="language-plaintext highlighter-rouge">:all_of</code> or <code class="language-plaintext highlighter-rouge">:with</code> to describe complex license expressions. <code class="language-plaintext highlighter-rouge">:any_of</code> should be used when the user can choose which license to use. <code class="language-plaintext highlighter-rouge">:all_of</code> should be used when the user must use all licenses. <code class="language-plaintext highlighter-rouge">:with</code> should be used to specify a valid SPDX exception. Add <code class="language-plaintext highlighter-rouge">+</code> to an identifier to indicate that the formulae can be licensed under later versions of the same license.</p> <p>Check out the <a href="license-guidelines">License Guidelines</a> for examples of complex license expressions in Homebrew formulae.</p> <h3 id="check-the-build-system">Check the build system</h3> <pre data-language="bash">HOMEBREW_NO_INSTALL_FROM_API=1 brew install --build-from-source --interactive foo</pre> <p>You‚Äôre now at a new prompt with the tarball extracted to a temporary sandbox.</p> <p>Check the package‚Äôs <code class="language-plaintext highlighter-rouge">README</code>. Does the package install with <code class="language-plaintext highlighter-rouge">./configure</code>, <code class="language-plaintext highlighter-rouge">cmake</code>, or something else? Delete the commented out <code class="language-plaintext highlighter-rouge">cmake</code> lines if the package uses <code class="language-plaintext highlighter-rouge">./configure</code>.</p> <h3 id="check-for-dependencies">Check for dependencies</h3> <p>The <code class="language-plaintext highlighter-rouge">README</code> probably tells you about dependencies and Homebrew or macOS probably already has them. You can check for Homebrew dependencies with <code class="language-plaintext highlighter-rouge">brew search</code>. Some common dependencies that macOS comes with:</p> <ul> <li><code class="language-plaintext highlighter-rouge">libexpat</code></li> <li><code class="language-plaintext highlighter-rouge">libGL</code></li> <li><code class="language-plaintext highlighter-rouge">libiconv</code></li> <li><code class="language-plaintext highlighter-rouge">libpcap</code></li> <li><code class="language-plaintext highlighter-rouge">libxml2</code></li> <li><code class="language-plaintext highlighter-rouge">python</code></li> <li><code class="language-plaintext highlighter-rouge">ruby</code></li> </ul> <p>There are plenty of others; check <code class="language-plaintext highlighter-rouge">/usr/lib</code> for them.</p> <p>We generally try not to duplicate system libraries and complicated tools in core Homebrew but we do duplicate some commonly used tools.</p> <p>Special exceptions are OpenSSL and LibreSSL. Things that use either <em>should</em> be built using Homebrew‚Äôs shipped equivalent and our BrewTestBot‚Äôs post-install <code class="language-plaintext highlighter-rouge">audit</code> will warn if it detects you haven‚Äôt done this.</p> <p><strong>Important:</strong> <code class="language-plaintext highlighter-rouge">$(brew --prefix)/bin</code> is NOT in the <code class="language-plaintext highlighter-rouge">PATH</code> during formula installation. If you have dependencies at build time, you must specify them and <code class="language-plaintext highlighter-rouge">brew</code> will add them to the <code class="language-plaintext highlighter-rouge">PATH</code> or create a <a href="https://rubydoc.brew.sh/Requirement"><code class="language-plaintext highlighter-rouge">Requirement</code></a>.</p> <h3 id="specifying-other-formulae-as-dependencies">Specifying other formulae as dependencies</h3> <pre data-language="ruby">class Foo &lt; Formula
  # ...

  depends_on "httpd" =&gt; [:build, :test]
  depends_on xcode: ["9.3", :build]
  depends_on arch: :x86_64
  depends_on "jpeg"
  depends_on macos: :high_sierra
  depends_on "pkg-config"
  depends_on "readline" =&gt; :recommended
  depends_on "gtk+" =&gt; :optional

  # ...
end</pre> <p>A <code class="language-plaintext highlighter-rouge">String</code> (e.g. <code class="language-plaintext highlighter-rouge">"jpeg"</code>) specifies a formula dependency.</p> <p>A <code class="language-plaintext highlighter-rouge">Symbol</code> (e.g. <code class="language-plaintext highlighter-rouge">:xcode</code>) specifies a <a href="https://rubydoc.brew.sh/Requirement"><code class="language-plaintext highlighter-rouge">Requirement</code></a> to restrict installation to systems meeting certain criteria, which can be fulfilled by one or more formulae, casks or other system-wide installed software (e.g. Xcode). Some <a href="https://rubydoc.brew.sh/Requirement"><code class="language-plaintext highlighter-rouge">Requirement</code></a>s can also take a string or symbol specifying their minimum version that the formula depends on.</p> <p>A <code class="language-plaintext highlighter-rouge">Hash</code> (e.g. <code class="language-plaintext highlighter-rouge">=&gt;</code>) adds information to a dependency. Given a string or symbol, the value can be one or more of the following values:</p> <ul> <li>
<code class="language-plaintext highlighter-rouge">:build</code> means this is a build-time only dependency so it can be skipped when installing from a bottle or when listing missing dependencies using <code class="language-plaintext highlighter-rouge">brew missing</code>.</li> <li>
<code class="language-plaintext highlighter-rouge">:test</code> means this is only required when running <code class="language-plaintext highlighter-rouge">brew test</code>.</li> <li>
<code class="language-plaintext highlighter-rouge">:optional</code> (not allowed in <code class="language-plaintext highlighter-rouge">Homebrew/homebrew-core</code>) generates an implicit <code class="language-plaintext highlighter-rouge">with-foo</code> option for the formula. This means that, given <code class="language-plaintext highlighter-rouge">depends_on "foo" =&gt; :optional</code>, the user must pass <code class="language-plaintext highlighter-rouge">--with-foo</code> to use the dependency.</li> <li>
<code class="language-plaintext highlighter-rouge">:recommended</code> (not allowed in <code class="language-plaintext highlighter-rouge">Homebrew/homebrew-core</code>) generates an implicit <code class="language-plaintext highlighter-rouge">without-foo</code> option, meaning that the dependency is enabled by default and the user must pass <code class="language-plaintext highlighter-rouge">--without-foo</code> to disable this dependency. The default description can be overridden using the <a href="https://rubydoc.brew.sh/Formula#option-class_method"><code class="language-plaintext highlighter-rouge">option</code></a> syntax (in this case, the <a href="#adding-optional-steps"><code class="language-plaintext highlighter-rouge">option</code> declaration</a> must precede the dependency):</li> </ul> <pre data-language="ruby">option "with-foo", "Compile with foo bindings" # This overrides the generated description if you want to
depends_on "foo" =&gt; :optional # Generated description would otherwise be "Build with foo support"</pre> <ul> <li>
<code class="language-plaintext highlighter-rouge">"&lt;option-name&gt;"</code> (not allowed in <code class="language-plaintext highlighter-rouge">Homebrew/homebrew-core</code>) requires a dependency to have been built with the specified option.</li> </ul> <h3 id="specifying-conflicts-with-other-formulae">Specifying conflicts with other formulae</h3> <p>Sometimes there‚Äôs a hard conflict between formulae that can‚Äôt be avoided or circumvented with <a href="https://rubydoc.brew.sh/Formula#keg_only-class_method"><code class="language-plaintext highlighter-rouge">keg_only</code></a>.</p> <p>A good example for minor conflict is the <a href="https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/m/mbedtls.rb"><code class="language-plaintext highlighter-rouge">mbedtls</code></a> formula, which ships and compiles a ‚ÄúHello World‚Äù executable. This is obviously non-essential to <code class="language-plaintext highlighter-rouge">mbedtls</code>‚Äôs functionality, and as conflict with the popular GNU <a href="https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/h/hello.rb"><code class="language-plaintext highlighter-rouge">hello</code></a> formula would be overkill, we just <a href="https://github.com/Homebrew/homebrew-core/blob/442f9cc511ce6dfe75b96b2c83749d90dde914d2/Formula/m/mbedtls.rb#L52-L53">remove it</a> during the installation process.</p> <p><a href="https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/p/pdftohtml.rb"><code class="language-plaintext highlighter-rouge">pdftohtml</code></a> provides an example of a serious conflict, where each listed formula ships an identically named binary that is essential to functionality, so a <a href="https://rubydoc.brew.sh/Formula#conflicts_with-class_method"><code class="language-plaintext highlighter-rouge">conflicts_with</code></a> is preferable.</p> <p>As a general rule, <a href="https://rubydoc.brew.sh/Formula#conflicts_with-class_method"><code class="language-plaintext highlighter-rouge">conflicts_with</code></a> should be a last-resort option. It‚Äôs a fairly blunt instrument.</p> <p>The syntax for a conflict that can‚Äôt be worked around is:</p> <pre data-language="ruby">conflicts_with "blueduck", because: "yellowduck also ships a duck binary"</pre> <h3 id="formulae-revisions">Formulae revisions</h3> <p>In Homebrew we sometimes accept formulae updates that don‚Äôt include a version bump. These include resource updates, new patches or fixing a security issue with a formula.</p> <p>Occasionally, these updates require a forced-recompile of the formula itself or its dependents to either ensure formulae continue to function as expected or to close a security issue. This forced-recompile is known as a <a href="https://rubydoc.brew.sh/Formula#revision-class_method"><code class="language-plaintext highlighter-rouge">revision</code></a> and is inserted underneath the <a href="https://rubydoc.brew.sh/Formula#homepage-class_method"><code class="language-plaintext highlighter-rouge">homepage</code></a>/<a href="https://rubydoc.brew.sh/Formula#url-class_method"><code class="language-plaintext highlighter-rouge">url</code></a>/<a href="https://rubydoc.brew.sh/Formula#sha256-class_method"><code class="language-plaintext highlighter-rouge">sha256</code></a>/<a href="https://rubydoc.brew.sh/Formula#license-class_method"><code class="language-plaintext highlighter-rouge">license</code></a> block.</p> <p>When a dependent of a formula fails to build against a new version of that dependency it must receive a <a href="https://rubydoc.brew.sh/Formula#revision-class_method"><code class="language-plaintext highlighter-rouge">revision</code></a>. An example of such failure is in <a href="https://github.com/Homebrew/legacy-homebrew/issues/31195">this issue report</a> and <a href="https://github.com/Homebrew/legacy-homebrew/pull/31207">its fix</a>.</p> <p><a href="https://rubydoc.brew.sh/Formula#revision-class_method"><code class="language-plaintext highlighter-rouge">revision</code></a>s are also used for formulae that move from the system OpenSSL to the Homebrew-shipped OpenSSL without any other changes to that formula. This ensures users aren‚Äôt left exposed to the potential security issues of the outdated OpenSSL. An example of this can be seen in <a href="https://github.com/Homebrew/homebrew-core/commit/0d4453a91923e6118983961e18d0609e9828a1a4">this commit</a>.</p> <h3 id="version-scheme-changes">Version scheme changes</h3> <p>Sometimes formulae have version schemes that change such that a direct comparison between two versions no longer produces the correct result. For example, a project might be version <code class="language-plaintext highlighter-rouge">13</code> and then decide to become <code class="language-plaintext highlighter-rouge">1.0.0</code>. As <code class="language-plaintext highlighter-rouge">13</code> is translated to <code class="language-plaintext highlighter-rouge">13.0.0</code> by our versioning system by default this requires intervention.</p> <p>When a version scheme of a formula fails to recognise a new version as newer it must receive a <a href="https://rubydoc.brew.sh/Formula#version_scheme-class_method"><code class="language-plaintext highlighter-rouge">version_scheme</code></a>. An example of this can be seen in <a href="https://github.com/Homebrew/homebrew-core/pull/4006">this pull request</a>.</p> <h3 id="double-check-for-dependencies">Double-check for dependencies</h3> <p>When you already have a lot of formulae installed, it‚Äôs easy to miss a common dependency. You can double-check which libraries a binary links to with the <code class="language-plaintext highlighter-rouge">otool</code> command (perhaps you need to use <code class="language-plaintext highlighter-rouge">xcrun otool</code>):</p> <pre data-language="console">$ otool -L /opt/homebrew/bin/ldapvi
/opt/homebrew/bin/ldapvi:
    /opt/homebrew/opt/openssl/lib/libssl.1.0.0.dylib (compatibility version 1.0.0, current version 1.0.0)
    /opt/homebrew/opt/openssl/lib/libcrypto.1.0.0.dylib (compatibility version 1.0.0, current version 1.0.0)
    /opt/homebrew/lib/libglib-2.0.0.dylib (compatibility version 4201.0.0, current version 4201.0.0)
    /opt/homebrew/opt/gettext/lib/libintl.8.dylib (compatibility version 10.0.0, current version 10.2.0)
    /opt/homebrew/opt/readline/lib/libreadline.6.dylib (compatibility version 6.0.0, current version 6.3.0)
    /opt/homebrew/lib/libpopt.0.dylib (compatibility version 1.0.0, current version 1.0.0)
    /usr/lib/libncurses.5.4.dylib (compatibility version 5.4.0, current version 5.4.0)
    /System/Library/Frameworks/LDAP.framework/Versions/A/LDAP (compatibility version 1.0.0, current version 2.4.0)
    /usr/lib/libresolv.9.dylib (compatibility version 1.0.0, current version 1.0.0)
    /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1213.0.0)</pre> <h3 id="specifying-macos-components-as-dependencies">Specifying macOS components as dependencies</h3> <p>If a formula dependency is required on all platforms but can be handled by a component that ships with macOS, specify it with <a href="https://rubydoc.brew.sh/Formula#uses_from_macos-class_method"><code class="language-plaintext highlighter-rouge">uses_from_macos</code></a>. On Linux it acts like <a href="https://rubydoc.brew.sh/Formula#depends_on-class_method"><code class="language-plaintext highlighter-rouge">depends_on</code></a>, while on macOS it‚Äôs ignored unless the host system is older than the optional <code class="language-plaintext highlighter-rouge">since:</code> parameter.</p> <p>For example, to require the <code class="language-plaintext highlighter-rouge">bzip2</code> formula on Linux while relying on built-in <code class="language-plaintext highlighter-rouge">bzip2</code> on macOS:</p> <pre data-language="ruby">uses_from_macos "bzip2"</pre> <p>To require the <code class="language-plaintext highlighter-rouge">perl</code> formula only when building or testing on Linux:</p> <pre data-language="ruby">uses_from_macos "perl" =&gt; [:build, :test]</pre> <p>To require the <code class="language-plaintext highlighter-rouge">curl</code> formula on Linux and pre-macOS 12:</p> <pre data-language="ruby">uses_from_macos "curl", since: :monterey</pre> <h3 id="specifying-gems-python-modules-go-projects-etc-as-dependencies">Specifying gems, Python modules, Go projects, etc. as dependencies</h3> <p>Homebrew doesn‚Äôt package already-packaged language-specific libraries. These should be installed directly from <code class="language-plaintext highlighter-rouge">gem</code>/<code class="language-plaintext highlighter-rouge">cpan</code>/<code class="language-plaintext highlighter-rouge">pip</code> etc.</p> <h3 id="ruby-gem-dependencies">Ruby Gem Dependencies</h3> <p>The preferred mechanism for installing gem dependencies is to use <code class="language-plaintext highlighter-rouge">bundler</code> with the upstream‚Äôs <code class="language-plaintext highlighter-rouge">Gemfile.lock</code>. This requires the upstream checks in their <code class="language-plaintext highlighter-rouge">Gemfile.lock</code>, so if they don‚Äôt, it‚Äôs a good idea to file an issue and ask them to do so. Assuming they have one, this is as simple as:</p> <pre data-language="ruby">ENV["GEM_HOME"] = libexec
system "bundle", "install", "--without", "development"</pre> <p>From there, you can build and install the project itself:</p> <pre data-language="ruby">system "gem", "build", "&lt;project&gt;.gemspec"
system "gem", "install", "--ignore-dependencies", "&lt;project&gt;-#{version}.gem"</pre> <p>And install any bins, and munge their shebang lines, with:</p> <pre data-language="ruby">bin.install libexec/"bin/&lt;bin&gt;"
bin.env_script_all_files(libexec/"bin", GEM_HOME: ENV.fetch("GEM_HOME", nil))</pre> <h3 id="python-dependencies">Python dependencies</h3> <p>For python we use <a href="https://rubydoc.brew.sh/Formula#resource-class_method"><code class="language-plaintext highlighter-rouge">resource</code></a>s for dependencies and there‚Äôs automation to generate these for you. Running <code class="language-plaintext highlighter-rouge">brew update-python-resources &lt;formula&gt;</code> will automatically add the necessary <a href="https://rubydoc.brew.sh/Formula#resource-class_method"><code class="language-plaintext highlighter-rouge">resource</code></a> stanzas for the dependencies of your Python application to the formula. Note that <code class="language-plaintext highlighter-rouge">brew update-python-resources</code> is run automatically by <code class="language-plaintext highlighter-rouge">brew create</code> if you pass the <code class="language-plaintext highlighter-rouge">--python</code> switch. If <code class="language-plaintext highlighter-rouge">brew update-python-resources</code> is unable to determine the correct <code class="language-plaintext highlighter-rouge">resource</code> stanzas, <a href="https://github.com/tdsmith/homebrew-pypi-poet">homebrew-pypi-poet</a> is a good third-party alternative that may help.</p> <h3 id="all-other-cases">All other cases</h3> <p>If all else fails, you‚Äôll want to use <a href="https://rubydoc.brew.sh/Formula#resource-class_method"><code class="language-plaintext highlighter-rouge">resource</code></a>s for all other language-specific dependencies. This requires you to specify both a specific URL for a version and the sha256 checksum for security. Here‚Äôs an example:</p> <pre data-language="ruby">class Foo &lt; Formula
  # ...
  url "https://example.com/foo-1.0.tar.gz"

  resource "pycrypto" do
    url "https://files.pythonhosted.org/packages/60/db/645aa9af249f059cc3a368b118de33889219e0362141e75d4eaf6f80f163/pycrypto-2.6.1.tar.gz"
    sha256 "f2ce1e989b272cfcb677616763e0a2e7ec659effa67a88aa92b3a65528f60a3c"
  end

  def install
    resource("pycrypto").stage { system "python", *Language::Python.setup_install_args(libexec/"vendor") }
  end
end</pre> <p><a href="https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/j/jrnl.rb"><code class="language-plaintext highlighter-rouge">jrnl</code></a> is an example of a formula that does this well. The end result means the user doesn‚Äôt have to use <code class="language-plaintext highlighter-rouge">pip</code> or Python and can just run <code class="language-plaintext highlighter-rouge">jrnl</code>.</p> <h3 id="install-the-formula">Install the formula</h3> <pre data-language="bash">HOMEBREW_NO_INSTALL_FROM_API=1 brew install --build-from-source --verbose --debug foo</pre> <p><code class="language-plaintext highlighter-rouge">--debug</code> will ask you to open an interactive shell if the build fails so you can try to figure out what went wrong.</p> <p>Check the top of the e.g. <code class="language-plaintext highlighter-rouge">./configure</code> output. Some configure scripts do not recognise e.g. <code class="language-plaintext highlighter-rouge">--disable-debug</code>. If you see a warning about it, remove the option from the formula.</p> <h3 id="add-a-test-to-the-formula">Add a test to the formula</h3> <p>Add a valid test to the <a href="https://rubydoc.brew.sh/Formula#test-class_method"><code class="language-plaintext highlighter-rouge">test do</code></a> block of the formula. This will be run by <code class="language-plaintext highlighter-rouge">brew test foo</code> and <a href="brewtestbot">BrewTestBot</a>.</p> <p>The <a href="https://rubydoc.brew.sh/Formula#test-class_method"><code class="language-plaintext highlighter-rouge">test do</code></a> block automatically creates and changes to a temporary directory which is deleted after run. You can access this <a href="https://rubydoc.brew.sh/Pathname"><code class="language-plaintext highlighter-rouge">Pathname</code></a> with the <a href="https://rubydoc.brew.sh/Formula#testpath-instance_method"><code class="language-plaintext highlighter-rouge">testpath</code></a> function. The environment variable <code class="language-plaintext highlighter-rouge">HOME</code> is set to <a href="https://rubydoc.brew.sh/Formula#testpath-instance_method"><code class="language-plaintext highlighter-rouge">testpath</code></a> within the <a href="https://rubydoc.brew.sh/Formula#test-class_method"><code class="language-plaintext highlighter-rouge">test do</code></a> block.</p> <p>We want tests that don‚Äôt require any user input and test the basic functionality of the application. For example <code class="language-plaintext highlighter-rouge">foo build-foo input.foo</code> is a good test and (despite their widespread use) <code class="language-plaintext highlighter-rouge">foo --version</code> and <code class="language-plaintext highlighter-rouge">foo --help</code> are bad tests. However, a bad test is better than no test at all.</p> <p>See the <a href="https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/c/cmake.rb"><code class="language-plaintext highlighter-rouge">cmake</code></a> formula for an example of a good test. It writes a basic <code class="language-plaintext highlighter-rouge">CMakeLists.txt</code> file into the test directory then calls CMake to generate Makefiles. This test checks that CMake doesn‚Äôt e.g. segfault during basic operation.</p> <p>You can check that the output is as expected with <code class="language-plaintext highlighter-rouge">assert_equal</code> or <code class="language-plaintext highlighter-rouge">assert_match</code> on the output of the formula‚Äôs <a href="https://rubydoc.brew.sh/Homebrew/Assertions">assertions</a> such as in this example from the <a href="https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/e/envv.rb"><code class="language-plaintext highlighter-rouge">envv</code></a> formula:</p> <pre data-language="ruby">assert_equal "mylist=A:C; export mylist", shell_output("#{bin}/envv del mylist B").strip</pre> <p>You can also check that an output file was created:</p> <pre data-language="ruby">assert_predicate testpath/"output.txt", :exist?</pre> <p>Some advice for specific cases:</p> <ul> <li>If the formula is a library, compile and run some simple code that links against it. It could be taken from upstream‚Äôs documentation / source examples. A good example is <a href="https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/t/tinyxml2.rb"><code class="language-plaintext highlighter-rouge">tinyxml2</code></a>‚Äôs test, which writes a small C++ source file into the test directory, compiles and links it against the tinyxml2 library and finally checks that the resulting program runs successfully.</li> <li>If the formula is for a GUI program, try to find some function that runs as command-line only, like a format conversion, reading or displaying a config file, etc.</li> <li>If the software cannot function without credentials or requires a virtual machine, docker instance, etc. to run, a test could be to try to connect with invalid credentials (or without credentials) and confirm that it fails as expected. This is preferred over mocking a dependency.</li> <li>Homebrew comes with a number of <a href="https://github.com/Homebrew/brew/tree/HEAD/Library/Homebrew/test/support/fixtures">standard test fixtures</a>, including numerous sample images, sounds, and documents in various formats. You can get the file path to a test fixture with e.g. <code class="language-plaintext highlighter-rouge">test_fixtures("test.svg")</code>.</li> <li>If your test requires a test file that isn‚Äôt a standard test fixture, you can install it from a source repository during the <code class="language-plaintext highlighter-rouge">test</code> phase with a <a href="https://rubydoc.brew.sh/Formula#resource-class_method"><code class="language-plaintext highlighter-rouge">resource</code></a> block, like this:</li> </ul> <pre data-language="ruby">test do
  resource "testdata" do
    url "https://example.com/input.foo"
    sha256 "ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff"
  end

  resource("testdata").stage do
    assert_match "OK", shell_output("#{bin}/foo build-foo input.foo")
  end
end</pre> <ul> <li>If the binary only writes to <code class="language-plaintext highlighter-rouge">stderr</code>, you can redirect <code class="language-plaintext highlighter-rouge">stderr</code> to <code class="language-plaintext highlighter-rouge">stdout</code> for assertions with <code class="language-plaintext highlighter-rouge">shell_output</code>. For example:</li> </ul> <pre data-language="ruby">test do
  assert_match "Output on stderr", shell_output("#{bin}/formula-program 2&gt;&amp;1", 2)
end</pre> <h3 id="manuals">Manuals</h3> <p>Homebrew expects to find manual pages in <code class="language-plaintext highlighter-rouge">#{prefix}/share/man/...</code>, and not in <code class="language-plaintext highlighter-rouge">#{prefix}/man/...</code>.</p> <p>Some software installs to <code class="language-plaintext highlighter-rouge">man</code> instead of <code class="language-plaintext highlighter-rouge">share/man</code>, so check the output and add a <code class="language-plaintext highlighter-rouge">"--mandir=#{man}"</code> to the <code class="language-plaintext highlighter-rouge">./configure</code> line if needed.</p> <h3 id="caveats">Caveats</h3> <p>In case there are specific issues with the Homebrew packaging (compared to how the software is installed from other sources) a <code class="language-plaintext highlighter-rouge">caveats</code> block can be added to the formula to warn users. This can indicate non-standard install paths, like this example from the <a href="https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/r/ruby.rb"><code class="language-plaintext highlighter-rouge">ruby</code></a> formula:</p> <pre data-language="plaintext">==&gt; Caveats
By default, binaries installed by gem will be placed into:
  /opt/homebrew/lib/ruby/gems/3.4.0/bin

You may want to add this to your PATH.</pre> <h3 id="a-quick-word-on-naming">A quick word on naming</h3> <p>Name the formula like the project markets the product. So it‚Äôs <code class="language-plaintext highlighter-rouge">pkg-config</code>, not <code class="language-plaintext highlighter-rouge">pkgconfig</code>; <code class="language-plaintext highlighter-rouge">sdl_mixer</code>, not <code class="language-plaintext highlighter-rouge">sdl-mixer</code> or <code class="language-plaintext highlighter-rouge">sdlmixer</code>.</p> <p>The only exception is stuff like ‚ÄúApache Ant‚Äù. Apache sticks ‚ÄúApache‚Äù in front of everything, but we use the formula name <code class="language-plaintext highlighter-rouge">ant</code>. We only include the prefix in cases like <code class="language-plaintext highlighter-rouge">gnuplot</code> (because it‚Äôs part of the name) and <code class="language-plaintext highlighter-rouge">gnu-go</code> (because everyone calls it ‚ÄúGNU Go‚Äù‚Äînobody just calls it ‚ÄúGo‚Äù). The word ‚ÄúGo‚Äù is too common and there are too many implementations of it.</p> <p>If you‚Äôre not sure about the name, check its homepage, Wikipedia page and <a href="https://www.debian.org/distrib/packages">what Debian calls it</a>.</p> <p>When Homebrew already has a formula called <code class="language-plaintext highlighter-rouge">foo</code> we typically do not accept requests to replace that formula with something else also named <code class="language-plaintext highlighter-rouge">foo</code>. This is to avoid both confusing and surprising users‚Äô expectations.</p> <p>When two formulae share an upstream name, e.g. <a href="https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/a/aescrypt.rb">AESCrypt</a> and <a href="https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/a/aescrypt-packetizer.rb">AES Crypt</a> the newer formula must typically adapt its name to avoid conflict with the current formula.</p> <p>If you‚Äôre <em>still</em> not sure, just commit. We‚Äôll apply some arbitrary rule and make a decision üòâ.</p> <p>When importing classes, Homebrew will require the formula and then create an instance of the class. It does this by assuming the formula name can be directly converted to the class name using a <code class="language-plaintext highlighter-rouge">regexp</code>. The rules are simple:</p> <ul> <li>
<code class="language-plaintext highlighter-rouge">foo-bar.rb</code> =&gt; <code class="language-plaintext highlighter-rouge">FooBar</code>
</li> <li>
<code class="language-plaintext highlighter-rouge">foobar.rb</code> =&gt; <code class="language-plaintext highlighter-rouge">Foobar</code>
</li> </ul> <p>Thus, if you change the name of the class, you must also rename the file. Filenames should be all lowercase, and class names should be the strict CamelCase equivalent, e.g. formulae <code class="language-plaintext highlighter-rouge">gnu-go</code> and <code class="language-plaintext highlighter-rouge">sdl_mixer</code> become classes <code class="language-plaintext highlighter-rouge">GnuGo</code> and <code class="language-plaintext highlighter-rouge">SdlMixer</code>, even if part of their name is an acronym.</p> <p>Add aliases by creating symlinks in an <code class="language-plaintext highlighter-rouge">Aliases</code> directory in the tap root.</p> <h3 id="audit-the-formula">Audit the formula</h3> <p>You can run <code class="language-plaintext highlighter-rouge">brew audit --strict --online</code> to test formulae for adherence to Homebrew house style, which is loosely based on the <a href="https://github.com/rubocop-hq/ruby-style-guide#the-ruby-style-guide">Ruby Style Guide</a>. The <code class="language-plaintext highlighter-rouge">audit</code> command includes warnings for trailing whitespace, preferred URLs for certain source hosts, and many other style issues. Fixing these warnings before committing will make the process a lot quicker for everyone.</p> <p>New formulae being submitted to Homebrew should run <code class="language-plaintext highlighter-rouge">brew audit --new --formula foo</code>. This command is performed by BrewTestBot on new submissions as part of the automated build and test process, and highlights more potential issues than the standard audit.</p> <p>Use <code class="language-plaintext highlighter-rouge">brew info</code> and check if the version guessed by Homebrew from the URL is correct. Add an explicit <a href="https://rubydoc.brew.sh/Formula#version-class_method"><code class="language-plaintext highlighter-rouge">version</code></a> if not.</p> <h3 id="commit">Commit</h3> <p>Everything is built on Git, so contribution is easy:</p> <pre data-language="bash">brew update # required in more ways than you think (initialises the Homebrew/brew Git repository if you don't already have it)
cd "$(brew --repository homebrew/core)"
# Create a new git branch for your formula so your pull request is easy to
# modify if any changes come up during review.
git checkout -b &lt;some-descriptive-name&gt; origin/HEAD
git add Formula/f/foo.rb
git commit</pre> <p>The established standard for Git commit messages is:</p> <ul> <li>the first line is a commit summary of <em>50 characters or less</em>
</li> <li>two (2) newlines, then</li> <li>explain the commit thoroughly.</li> </ul> <p>At Homebrew, we require the name of the formula up front like so: <code class="language-plaintext highlighter-rouge">foobar 7.3 (new formula)</code>.</p> <p>This may seem crazy short, but you‚Äôll find that forcing yourself to summarise the commit encourages you to be atomic and concise. If you can‚Äôt summarise it in 50 to 80 characters, you‚Äôre probably trying to commit two commits as one. For a more thorough explanation, please read Tim Pope‚Äôs excellent blog post, <a href="https://tbaggery.com/2008/04/19/a-note-about-git-commit-messages.html">A Note About Git Commit Messages</a>.</p> <p>The required commit message format for simple version updates is <code class="language-plaintext highlighter-rouge">foobar 7.3</code> and for fixes is <code class="language-plaintext highlighter-rouge">foobar: fix flibble matrix.</code>. Please squash your commits into one with this message format, otherwise your PR will be replaced by our autosquash workflow.</p> <p>Ensure you reference any relevant GitHub issue, e.g. <code class="language-plaintext highlighter-rouge">Closes #12345</code> in the commit message. Homebrew‚Äôs history is the first thing future contributors will look to when trying to understand the current state of formulae they‚Äôre interested in.</p> <h3 id="push">Push</h3> <p>Now you just need to push your commit to GitHub.</p> <p>If you haven‚Äôt forked Homebrew yet, <a href="https://github.com/Homebrew/homebrew-core">go to the Homebrew/homebrew-core repository and hit the Fork button</a>.</p> <p>If you have already forked Homebrew on GitHub, then you can manually push (just make sure you have been pulling from the <code class="language-plaintext highlighter-rouge">Homebrew/homebrew-core</code> default branch):</p> <pre data-language="bash">git push https://github.com/myname/homebrew-core/ &lt;what-you-named-your-branch&gt;</pre> <p>Now, <a href="how-to-open-a-homebrew-pull-request">open a pull request</a> for your changes.</p> <ul> <li>One formula per commit; one commit per formula.</li> <li>Keep merge commits out of the pull request.</li> </ul> <h2 id="convenience-tools">Convenience tools</h2> <h3 id="messaging">Messaging</h3> <p>Three commands are provided for displaying informational messages to the user:</p> <ul> <li>
<code class="language-plaintext highlighter-rouge">ohai</code> for general info</li> <li>
<code class="language-plaintext highlighter-rouge">opoo</code> for warning messages</li> <li>
<code class="language-plaintext highlighter-rouge">odie</code> for error messages and immediately exiting</li> </ul> <p>Use <code class="language-plaintext highlighter-rouge">odie</code> when you need to exit a formula gracefully for any reason. For example:</p> <pre data-language="ruby">if build.head?
  lib_jar = Dir["cfr-*-SNAPSHOT.jar"]
  doc_jar = Dir["cfr-*-SNAPSHOT-javadoc.jar"]
  odie "Unexpected number of artifacts!" if (lib_jar.length != 1) || (doc_jar.length != 1)
end</pre> <h3 id="standard-arguments">Standard arguments</h3> <p>For any formula using certain well-known build systems, there will be arguments that should be passed during compilation so that the build conforms to Homebrew standards. These have been collected into a set of <code class="language-plaintext highlighter-rouge">std_*_args</code> methods. Detailed information about each of those methods can be found in the <a href="https://rubydoc.brew.sh/Formula"><code class="language-plaintext highlighter-rouge">Formula</code> class API</a> documentation.</p> <p>Most of these methods accept parameters to customize their output. For example, to set the install prefix to <a href="#variables-for-directory-locations"><strong><code class="language-plaintext highlighter-rouge">libexec</code></strong></a> for <code class="language-plaintext highlighter-rouge">configure</code> or <code class="language-plaintext highlighter-rouge">cmake</code>:</p> <pre data-language="ruby">system "./configure", *std_configure_args(prefix: libexec)
system "cmake", "-S", ".", "-B", "build", *std_cmake_args(install_prefix: libexec)</pre> <p>The <code class="language-plaintext highlighter-rouge">std_*_args</code> methods, as well as the arguments they pass, are:</p> <h4 id="std_cabal_v2_args"><code class="language-plaintext highlighter-rouge">std_cabal_v2_args</code></h4> <pre data-language="ruby">"--jobs=#{ENV.make_jobs}"
"--max-backjumps=100000"
"--install-method=copy"
"--installdir=#{bin}"</pre> <h4 id="std_cargo_args"><code class="language-plaintext highlighter-rouge">std_cargo_args</code></h4> <pre data-language="ruby">"--locked"
"--root=#{root}"
"--path=#{path}"</pre> <h4 id="std_cmake_args"><code class="language-plaintext highlighter-rouge">std_cmake_args</code></h4> <pre data-language="ruby">"-DCMAKE_INSTALL_PREFIX=#{install_prefix}"
"-DCMAKE_INSTALL_LIBDIR=#{install_libdir}"
"-DCMAKE_BUILD_TYPE=Release"
"-DCMAKE_FIND_FRAMEWORK=#{find_framework}"
"-DCMAKE_VERBOSE_MAKEFILE=ON"
"-DCMAKE_PROJECT_TOP_LEVEL_INCLUDES=#{HOMEBREW_LIBRARY_PATH}/cmake/trap_fetchcontent_provider.cmake"
"-Wno-dev"
"-DBUILD_TESTING=OFF"</pre> <h4 id="std_configure_args"><code class="language-plaintext highlighter-rouge">std_configure_args</code></h4> <pre data-language="ruby">"--disable-debug"
"--disable-dependency-tracking"
"--prefix=#{prefix}"
"--libdir=#{libdir}"</pre> <h4 id="std_go_args"><code class="language-plaintext highlighter-rouge">std_go_args</code></h4> <pre data-language="ruby">"-trimpath"
"-o=#{output}"</pre> <p>It also provides a convenient way to set <code class="language-plaintext highlighter-rouge">-ldflags</code>, <code class="language-plaintext highlighter-rouge">-gcflags</code>, and <code class="language-plaintext highlighter-rouge">-tags</code>, see examples: <a href="https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/b/babelfish.rb"><code class="language-plaintext highlighter-rouge">babelfish</code></a> and <a href="https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/w/wazero.rb"><code class="language-plaintext highlighter-rouge">wazero</code></a> formulae.</p> <h4 id="std_meson_args"><code class="language-plaintext highlighter-rouge">std_meson_args</code></h4> <pre data-language="ruby">"--prefix=#{prefix}"
"--libdir=#{lib}"
"--buildtype=release"
"--wrap-mode=nofallback"</pre> <h4 id="std_npm_args"><code class="language-plaintext highlighter-rouge">std_npm_args</code></h4> <pre data-language="ruby">"-ddd"
"--global"
"--build-from-source"
"--cache=$(brew --cache)/npm_cache"
"--prefix=#{libexec}"</pre> <h4 id="std_pip_args"><code class="language-plaintext highlighter-rouge">std_pip_args</code></h4> <pre data-language="ruby">"--verbose"
"--no-deps"
"--no-binary=:all:"
"--ignore-installed"
"--no-compile"</pre> <h4 id="std_zig_args"><code class="language-plaintext highlighter-rouge">std_zig_args</code></h4> <pre data-language="ruby">"--prefix"
prefix
"--release=#{release_mode}"
"-Doptimize=Release#{release_mode}"
"--summary"
"all"</pre> <p><code class="language-plaintext highlighter-rouge">release_mode</code> is a symbol that accepts only <code class="language-plaintext highlighter-rouge">:fast</code>, <code class="language-plaintext highlighter-rouge">:safe</code>, and <code class="language-plaintext highlighter-rouge">:small</code> values (with <code class="language-plaintext highlighter-rouge">:fast</code> being default).</p> <h3 id="bininstall-foo"><code class="language-plaintext highlighter-rouge">bin.install "foo"</code></h3> <p>You‚Äôll see stuff like this in some formulae. This moves the file <code class="language-plaintext highlighter-rouge">foo</code> into the formula‚Äôs <code class="language-plaintext highlighter-rouge">bin</code> directory (<code class="language-plaintext highlighter-rouge">/opt/homebrew/Cellar/pkg/0.1/bin</code>) and makes it executable (<code class="language-plaintext highlighter-rouge">chmod 0555 foo</code>). Variables for the most common <a href="#variables-for-directory-locations">directory locations</a> are available.</p> <p>You can also rename the file during the installation process. This can be useful for adding a prefix to binaries that would otherwise cause conflicts with another formula, or for removing a file extension. For example, to install <code class="language-plaintext highlighter-rouge">foo.py</code> into the formula‚Äôs <code class="language-plaintext highlighter-rouge">bin</code> directory (<code class="language-plaintext highlighter-rouge">/opt/homebrew/Cellar/pkg/0.1/bin</code>) as just <code class="language-plaintext highlighter-rouge">foo</code> instead of <code class="language-plaintext highlighter-rouge">foo.py</code>:</p> <pre data-language="ruby">bin.install "foo.py" =&gt; "foo"</pre> <h3 id="inreplace"><code class="language-plaintext highlighter-rouge">inreplace</code></h3> <p><a href="https://rubydoc.brew.sh/Utils/Inreplace"><code class="language-plaintext highlighter-rouge">inreplace</code></a> is a convenience function that can edit files in-place. For example:</p> <pre data-language="ruby">inreplace "path", before, after</pre> <p><code class="language-plaintext highlighter-rouge">before</code> and <code class="language-plaintext highlighter-rouge">after</code> can be strings or regular expressions. You should use the block form if you need to make multiple replacements in a file:</p> <pre data-language="ruby">inreplace "path" do |s|
  s.gsub!(/foo/, "bar")
  s.gsub! "123", "456"
end</pre> <p>Make sure you modify <code class="language-plaintext highlighter-rouge">s</code>! This block ignores the returned value.</p> <p><a href="https://rubydoc.brew.sh/Utils/Inreplace"><code class="language-plaintext highlighter-rouge">inreplace</code></a> should be used instead of patches when patching something that will never be accepted upstream, e.g. making the software‚Äôs build system respect Homebrew‚Äôs installation hierarchy. If it‚Äôs something that affects both Homebrew and MacPorts (i.e. macOS specific) it should be turned into an upstream submitted patch instead.</p> <p>If you need to modify variables in a <code class="language-plaintext highlighter-rouge">Makefile</code>, rather than using <a href="https://rubydoc.brew.sh/StringInreplaceExtension#change_make_var!-instance_method"><code class="language-plaintext highlighter-rouge">change_make_var!</code></a> within an <a href="https://rubydoc.brew.sh/Utils/Inreplace"><code class="language-plaintext highlighter-rouge">inreplace</code></a>, try passing them as arguments to <code class="language-plaintext highlighter-rouge">make</code>:</p> <pre data-language="ruby">system "make", "target", "VAR2=value1", "VAR2=value2", "VAR3=values can have spaces"</pre> <pre data-language="ruby">system "make", "CC=#{ENV.cc}", "PREFIX=#{prefix}"</pre> <p>Note that values <em>can</em> contain unescaped spaces if you use the multiple-argument form of <code class="language-plaintext highlighter-rouge">system</code>.</p> <h2 id="patches">Patches</h2> <p>While <a href="https://rubydoc.brew.sh/Formula#patch-class_method"><code class="language-plaintext highlighter-rouge">patch</code></a>es should generally be avoided, sometimes they are temporarily necessary.</p> <p>When <a href="https://rubydoc.brew.sh/Formula#patch-class_method"><code class="language-plaintext highlighter-rouge">patch</code></a>ing (i.e. fixing header file inclusion, fixing compiler warnings, etc.) the first thing to do is check whether the upstream project is aware of the issue. If not, file a bug report and/or submit your patch for inclusion. We may sometimes still accept your patch before it was submitted upstream but by getting the ball rolling on fixing the upstream issue you reduce the length of time we have to carry the patch around.</p> <p><em>Always justify a <a href="https://rubydoc.brew.sh/Formula#patch-class_method"><code class="language-plaintext highlighter-rouge">patch</code></a> with a code comment!</em> Otherwise, nobody will know when it is safe to remove the patch, or safe to leave it in when updating the formula. The comment should include a link to the relevant upstream issue(s).</p> <p>External <a href="https://rubydoc.brew.sh/Formula#patch-class_method"><code class="language-plaintext highlighter-rouge">patch</code></a>es can be declared using resource-style blocks:</p> <pre data-language="ruby">patch do
  url "https://example.com/example_patch.diff"
  sha256 "85cc828a96735bdafcf29eb6291ca91bac846579bcef7308536e0c875d6c81d7"
end</pre> <p>A strip level of <code class="language-plaintext highlighter-rouge">-p1</code> is assumed. It can be overridden using a symbol argument:</p> <pre data-language="ruby">patch :p0 do
  url "https://example.com/example_patch.diff"
  sha256 "85cc828a96735bdafcf29eb6291ca91bac846579bcef7308536e0c875d6c81d7"
end</pre> <p><a href="https://rubydoc.brew.sh/Formula#patch-class_method"><code class="language-plaintext highlighter-rouge">patch</code></a>es can be declared in <a href="https://rubydoc.brew.sh/Formula#stable-class_method"><code class="language-plaintext highlighter-rouge">stable</code></a> and <a href="https://rubydoc.brew.sh/Formula#head-class_method"><code class="language-plaintext highlighter-rouge">head</code></a> blocks. Always use a block instead of a conditional, i.e. <code class="language-plaintext highlighter-rouge">stable do ... end</code> instead of <code class="language-plaintext highlighter-rouge">if build.stable? then ... end</code>.</p> <pre data-language="ruby">stable do
  # ...

  patch do
    url "https://example.com/example_patch.diff"
    sha256 "85cc828a96735bdafcf29eb6291ca91bac846579bcef7308536e0c875d6c81d7"
  end
end</pre> <p>Embedded (<strong>END</strong>) patches can be declared like so:</p> <pre data-language="ruby">patch :DATA
patch :p0, :DATA</pre> <p>with the patch data included at the end of the file:</p> <pre data-language="plaintext">__END__
diff --git a/foo/showfigfonts b/foo/showfigfonts
index 643c60b..543379c 100644
--- a/foo/showfigfonts
+++ b/foo/showfigfonts
@@ -14,6 +14,7 @@
‚Ä¶</pre> <p>Patches can also be embedded by passing a string. This makes it possible to provide multiple embedded patches while making only some of them conditional.</p> <pre data-language="ruby">patch :p0, "..."</pre> <p>In embedded patches, the string ‚ÄúHOMEBREW_PREFIX‚Äù is replaced with the value of the constant <code class="language-plaintext highlighter-rouge">HOMEBREW_PREFIX</code> before the patch is applied.</p> <p>In external patches, the string ‚Äú@@HOMEBREW_PREFIX@@‚Äù is replaced with the value of the constant <code class="language-plaintext highlighter-rouge">HOMEBREW_PREFIX</code> before the patch is applied.</p> <h3 id="creating-the-diff">Creating the diff</h3> <pre data-language="bash">HOMEBREW_NO_INSTALL_FROM_API=1 brew install --interactive --git foo
# (make some edits)
git diff | pbcopy
brew edit foo</pre> <p>Now just paste into the formula after <code class="language-plaintext highlighter-rouge">__END__</code>.</p> <p>Instead of <code class="language-plaintext highlighter-rouge">git diff | pbcopy</code>, for some editors <code class="language-plaintext highlighter-rouge">git diff &gt;&gt; path/to/your/formula/foo.rb</code> might help you ensure that the patch is not altered, e.g. whitespace removal, indentation changes, etc.</p> <h2 id="advanced-formula-tricks">Advanced formula tricks</h2> <p>See the <a href="https://rubydoc.brew.sh/Formula"><code class="language-plaintext highlighter-rouge">Formula</code> class API</a> documentation for the full list of methods available within a formula. If anything isn‚Äôt clear, you can usually figure it out by <code class="language-plaintext highlighter-rouge">grep</code>ping the <code class="language-plaintext highlighter-rouge">$(brew --repository homebrew/core)</code> directory for examples. Please submit a pull request to amend this document if you think it will help!</p> <h3 id="handling-different-system-configurations">Handling different system configurations</h3> <p>Often, formulae need different dependencies, resources, patches, conflicts, deprecations or <code class="language-plaintext highlighter-rouge">keg_only</code> statuses on different OSes and architectures. In these cases, the components can be nested inside <code class="language-plaintext highlighter-rouge">on_macos</code>, <code class="language-plaintext highlighter-rouge">on_linux</code>, <code class="language-plaintext highlighter-rouge">on_arm</code> or <code class="language-plaintext highlighter-rouge">on_intel</code> blocks. For example, here‚Äôs how to add <code class="language-plaintext highlighter-rouge">gcc</code> as a Linux-only dependency:</p> <pre data-language="ruby">on_linux do
  depends_on "gcc"
end</pre> <p>Components can also be declared for specific macOS versions or version ranges. For example, to declare a dependency only on High Sierra, nest the <code class="language-plaintext highlighter-rouge">depends_on</code> call inside an <code class="language-plaintext highlighter-rouge">on_high_sierra</code> block. Add an <code class="language-plaintext highlighter-rouge">:or_older</code> or <code class="language-plaintext highlighter-rouge">:or_newer</code> parameter to the <code class="language-plaintext highlighter-rouge">on_high_sierra</code> method to add the dependency to all macOS versions that meet the condition. For example, to add <code class="language-plaintext highlighter-rouge">gettext</code> as a build dependency on Mojave and all later macOS versions, use:</p> <pre data-language="ruby">on_mojave :or_newer do
  depends_on "gettext" =&gt; :build
end</pre> <p>Sometimes, a dependency is needed on certain macOS versions <em>and</em> on Linux. In these cases, a special <code class="language-plaintext highlighter-rouge">on_system</code> method can be used:</p> <pre data-language="ruby">on_system :linux, macos: :sierra_or_older do
  depends_on "gettext" =&gt; :build
end</pre> <p>To check multiple conditions, nest the corresponding blocks. For example, the following code adds a <code class="language-plaintext highlighter-rouge">gettext</code> build dependency when on ARM <em>and</em> macOS:</p> <pre data-language="ruby">on_macos do
  on_arm do
    depends_on "gettext" =&gt; :build
  end
end</pre> <h4 id="inside-def-install-and-test-do">Inside <code class="language-plaintext highlighter-rouge">def install</code> and <code class="language-plaintext highlighter-rouge">test do</code>
</h4> <p>Inside <code class="language-plaintext highlighter-rouge">def install</code> and <code class="language-plaintext highlighter-rouge">test do</code>, don‚Äôt use these <code class="language-plaintext highlighter-rouge">on_*</code> methods. Instead, use <code class="language-plaintext highlighter-rouge">if</code> statements and the following conditionals:</p> <ul> <li>
<code class="language-plaintext highlighter-rouge">OS.mac?</code> and <code class="language-plaintext highlighter-rouge">OS.linux?</code> return <code class="language-plaintext highlighter-rouge">true</code> or <code class="language-plaintext highlighter-rouge">false</code> based on the OS</li> <li>
<code class="language-plaintext highlighter-rouge">Hardware::CPU.arm?</code> and <code class="language-plaintext highlighter-rouge">Hardware::CPU.intel?</code> return <code class="language-plaintext highlighter-rouge">true</code> or <code class="language-plaintext highlighter-rouge">false</code> based on the arch</li> <li>
<code class="language-plaintext highlighter-rouge">MacOS.version</code> returns the current macOS version. Use <code class="language-plaintext highlighter-rouge">==</code>, <code class="language-plaintext highlighter-rouge">&lt;=</code> or <code class="language-plaintext highlighter-rouge">&gt;=</code> to compare to symbols corresponding to macOS versions (e.g. <code class="language-plaintext highlighter-rouge">if MacOS.version &gt;= :mojave</code>)</li> </ul> <p>See the <a href="https://github.com/Homebrew/homebrew-core/blob/442f9cc511ce6dfe75b96b2c83749d90dde914d2/Formula/i/icoutils.rb#L36"><code class="language-plaintext highlighter-rouge">icoutils</code></a> formula for an example.</p> <h3 id="livecheck-blocks">
<code class="language-plaintext highlighter-rouge">livecheck</code> blocks</h3> <p>When <code class="language-plaintext highlighter-rouge">brew livecheck</code> is unable to identify versions for a formula, we can control its behavior using a <code class="language-plaintext highlighter-rouge">livecheck</code> block. Here is a simple example to check a page for links containing a filename like <code class="language-plaintext highlighter-rouge">example-1.2.tar.gz</code>:</p> <pre data-language="ruby">livecheck do
  url "https://www.example.com/downloads/"
  regex(/href=.*?example[._-]v?(\d+(?:\.\d+)+)\.t/i)
end</pre> <p>For <code class="language-plaintext highlighter-rouge">url</code>/<code class="language-plaintext highlighter-rouge">regex</code> guidelines and additional <code class="language-plaintext highlighter-rouge">livecheck</code> block examples, refer to the <a href="brew-livecheck"><code class="language-plaintext highlighter-rouge">brew livecheck</code></a> documentation. For more technical information on the methods used in a <code class="language-plaintext highlighter-rouge">livecheck</code> block, please refer to the <a href="https://rubydoc.brew.sh/Livecheck"><code class="language-plaintext highlighter-rouge">Livecheck</code> class</a> documentation.</p> <h3 id="excluding-formula-from-autobumping">Excluding formula from autobumping</h3> <p>By default, all new formulae in the <code class="language-plaintext highlighter-rouge">Homebrew/homebrew-core</code> repository are autobumped. This means that future updates are handled automatically by Homebrew CI jobs, and contributors do not have to submit pull requests.</p> <p>Sometimes, we want to exclude a formula from this list, for one reason or another. This can be done by adding the <code class="language-plaintext highlighter-rouge">no_autobump!</code> method in the formula definition; a reason must be provided with the <code class="language-plaintext highlighter-rouge">because:</code> parameter. It accepts a string or a symbol that corresponds to a preset reason, for example:</p> <pre data-language="ruby">no_autobump! because: :bumped_by_upstream</pre> <p>A complete list of allowed symbols can be found in <a href="https://rubydoc.brew.sh/top-level-namespace#NO_AUTOBUMP_REASONS_LIST-constant"><code class="language-plaintext highlighter-rouge">NO_AUTOBUMP_REASONS_LIST</code></a>.</p> <p>See our <a href="autobump">Autobump</a> documentation for more information about the autobump process.</p> <h3 id="url-download-strategies">URL download strategies</h3> <p>When parsing a download URL, Homebrew auto-detects the resource type it points to, whether archive (e.g. tarball, zip) or version control repository (e.g. Git, Subversion, Mercurial) and chooses an appropriate download strategy. Some strategies can be passed additional options to alter what‚Äôs downloaded. For example, to fetch a formula‚Äôs source code and infer its version number from a specific tag in a Git repository (useful for packages that rely on Git submodules), specify <a href="https://rubydoc.brew.sh/Formula#url-class_method"><code class="language-plaintext highlighter-rouge">url</code></a> with the <code class="language-plaintext highlighter-rouge">:tag</code> and <code class="language-plaintext highlighter-rouge">:revision</code> options, like so:</p> <pre data-language="ruby">class Foo &lt; Formula
  # ...
  url "https://github.com/some/package.git",
      tag:      "v1.6.2",
      revision: "344cd2ee3463abab4c16ac0f9529a846314932a2"
end</pre> <p>If fetching from a Subversion or Mercurial repository, specify <code class="language-plaintext highlighter-rouge">revision</code> and <code class="language-plaintext highlighter-rouge">version</code> separately:</p> <pre data-language="ruby">class Bar &lt; Formula
  # ...
  url "https://svn.code.sf.net/p/package/code/stable", revision: "4687"
  version "12.1.8"
end</pre> <p>To fetch specific revisions of Subversion externals, specify <code class="language-plaintext highlighter-rouge">revisions</code>:</p> <pre data-language="ruby">class Baz &lt; Formula
  # ...
  url "svn://source.something.org/package/trunk/",
      revisions: { trunk: "22916", "libsomething" =&gt; "31045" }
  version "7.2.11"
end</pre> <p>If not inferable, specify which of Homebrew‚Äôs built-in download strategies to use with the <code class="language-plaintext highlighter-rouge">using:</code> option. For example:</p> <pre data-language="ruby">class Nginx &lt; Formula
  desc "HTTP(S) server and reverse proxy, and IMAP/POP3 proxy server"
  homepage "https://nginx.org/"
  url "https://nginx.org/download/nginx-1.23.2.tar.gz", using: :homebrew_curl
  sha256 "a80cc272d3d72aaee70aa8b517b4862a635c0256790434dbfc4d618a999b0b46"
  head "https://hg.nginx.org/nginx/", using: :hg
end</pre> <p>Homebrew offers these anonymous download strategies.</p> <table> <thead> <tr> <th>
<code class="language-plaintext highlighter-rouge">using:</code> value</th> <th>download strategy</th> <th>requirements</th> </tr> </thead> <tbody> <tr> <td><code class="language-plaintext highlighter-rouge">:bzr</code></td> <td>fetch from Bazaar repository</td> <td>
<code class="language-plaintext highlighter-rouge">breezy</code> installed</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">:curl</code></td> <td>download using <code class="language-plaintext highlighter-rouge">curl</code> (default)</td> <td> </td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">:cvs</code></td> <td>fetch from CVS repository</td> <td>
<code class="language-plaintext highlighter-rouge">cvs</code> installed</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">:fossil</code></td> <td>fetch from Fossil repository</td> <td>
<code class="language-plaintext highlighter-rouge">fossil</code> installed</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">:git</code></td> <td>fetch from Git repository</td> <td>
<code class="language-plaintext highlighter-rouge">git</code> installed</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">:hg</code></td> <td>fetch from Mercurial repository</td> <td>
<code class="language-plaintext highlighter-rouge">hg</code> installed</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">:homebrew_curl</code></td> <td>download using brewed <code class="language-plaintext highlighter-rouge">curl</code>
</td> <td>
<code class="language-plaintext highlighter-rouge">curl</code> installed</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">:nounzip</code></td> <td>download without decompressing</td> <td> </td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">:post</code></td> <td>download using <code class="language-plaintext highlighter-rouge">curl</code> via POST</td> <td>
<code class="language-plaintext highlighter-rouge">data:</code> <a href="cask-cookbook#additional-url-parameters">hash of parameters</a>
</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">:svn</code></td> <td>fetch from Subversion repository</td> <td>
<code class="language-plaintext highlighter-rouge">svn</code> installed</td> </tr> </tbody> </table> <p>If you need more control over the way files are downloaded and staged, you can create a custom download strategy and specify it with the <code class="language-plaintext highlighter-rouge">:using</code> option:</p> <pre data-language="ruby">class MyDownloadStrategy &lt; SomeHomebrewDownloadStrategy
  def fetch(timeout: nil, **options)
    opoo "Unhandled options in #{self.class}#fetch: #{options.keys.join(", ")}" unless options.empty?

    # downloads output to `temporary_path`
  end
end

class Foo &lt; Formula
  url "something", using: MyDownloadStrategy
end</pre> <h3 id="unstable-versions-head">Unstable versions (<code class="language-plaintext highlighter-rouge">head</code>)</h3> <p>Formulae can specify an alternate download for the upstream project‚Äôs development/cutting-edge source (e.g. <code class="language-plaintext highlighter-rouge">master</code>/<code class="language-plaintext highlighter-rouge">main</code>/<code class="language-plaintext highlighter-rouge">trunk</code>) using <a href="https://rubydoc.brew.sh/Formula#head-class_method"><code class="language-plaintext highlighter-rouge">head</code></a>, which can be activated by passing <code class="language-plaintext highlighter-rouge">--HEAD</code> when installing. Specifying it is done in the same manner as <a href="https://rubydoc.brew.sh/Formula#url-class_method"><code class="language-plaintext highlighter-rouge">url</code></a>, with added conventions for fetching from version control repositories:</p> <ul> <li> <p>Git repositories <strong>must always</strong> specify <code class="language-plaintext highlighter-rouge">branch:</code>. If the repository is very large, specify <code class="language-plaintext highlighter-rouge">only_path</code> to <a href="cask-cookbook#git-urls">limit the checkout to one path</a>.</p> <pre data-language="bash">head "https://github.com/some/package.git", branch: "main"</pre> </li> <li> <p>Mercurial repositories need <code class="language-plaintext highlighter-rouge">branch:</code> specified to fetch a branch other than ‚Äúdefault‚Äù.</p> </li> <li> <p>Subversion repositories can specify <code class="language-plaintext highlighter-rouge">trust_cert: true</code> to <a href="cask-cookbook#subversion-urls">skip interactive certificate prompts</a>.</p> </li> <li> <p>CVS repositories can specify <code class="language-plaintext highlighter-rouge">module:</code> to check out a specific module.</p> </li> </ul> <p>You can also bundle the URL and any <code class="language-plaintext highlighter-rouge">head</code>-specific dependencies and resources in a <code class="language-plaintext highlighter-rouge">head do</code> block.</p> <pre data-language="ruby">class Foo &lt; Formula
  # ...

  head do
    url "https://hg.sr.ht/~user/foo", using: :hg, branch: "develop"

    depends_on "pkg-config" =&gt; :build

    resource "package" do
      url "https://github.com/other/package.git", branch: "main"
    end
  end
end</pre> <p>You can test whether the <a href="https://rubydoc.brew.sh/Formula#head-class_method"><code class="language-plaintext highlighter-rouge">head</code></a> is being built with <code class="language-plaintext highlighter-rouge">build.head?</code> in the <code class="language-plaintext highlighter-rouge">install</code> method.</p> <h3 id="compiler-selection">Compiler selection</h3> <p>Sometimes a package fails to build when using a certain compiler. Since recent <a href="xcode">Xcode versions</a> no longer include a GCC compiler we cannot simply force the use of GCC. Instead, the correct way to declare this is with the <a href="https://rubydoc.brew.sh/Formula#fails_with-class_method"><code class="language-plaintext highlighter-rouge">fails_with</code></a> DSL method. A properly constructed <a href="https://rubydoc.brew.sh/Formula#fails_with-class_method"><code class="language-plaintext highlighter-rouge">fails_with</code></a> block documents the latest compiler build version known to cause compilation to fail, and the cause of the failure. For example:</p> <pre data-language="ruby">fails_with :clang do
  build 211
  cause "Miscompilation resulting in segfault on queries"
end

fails_with :gcc do
  version "5" # fails with GCC 5.x and earlier
  cause "Requires C++17 support"
end

fails_with gcc: "7" do
  version "7.1" # fails with GCC 7.0 and 7.1 but not 7.2, or any other major GCC version
  cause &lt;&lt;-EOS
    warning: dereferencing type-punned pointer will break strict-aliasing rules
    Fixed in GCC 7.2, see https://gcc.gnu.org/bugzilla/show_bug.cgi?id=42136
  EOS
end</pre> <p>For <code class="language-plaintext highlighter-rouge">:clang</code>, <code class="language-plaintext highlighter-rouge">build</code> takes an integer (you can find this number in your <code class="language-plaintext highlighter-rouge">brew --config</code> output), while <code class="language-plaintext highlighter-rouge">:gcc</code> uses either just <code class="language-plaintext highlighter-rouge">version</code> which takes a string to indicate the last problematic GCC version, or a major version argument combined with <code class="language-plaintext highlighter-rouge">version</code> to single out a range of specific GCC releases. <code class="language-plaintext highlighter-rouge">cause</code> takes a string, and the use of heredocs is encouraged to improve readability and allow for more comprehensive documentation.</p> <p><a href="https://rubydoc.brew.sh/Formula#fails_with-class_method"><code class="language-plaintext highlighter-rouge">fails_with</code></a> declarations can be used with any of <code class="language-plaintext highlighter-rouge">:gcc</code>, <code class="language-plaintext highlighter-rouge">:llvm</code>, and <code class="language-plaintext highlighter-rouge">:clang</code>. Homebrew will use this information to select a working compiler (if one is available).</p> <h3 id="just-moving-some-files">Just moving some files</h3> <p>When your code in the install function is run, the current working directory is set to the extracted tarball. This makes it easy to just move some files:</p> <pre data-language="ruby">prefix.install "file1", "file2"</pre> <p>Or everything:</p> <pre data-language="ruby">prefix.install Dir["output/*"]</pre> <p>Or just the tarball‚Äôs top-level files like README, LICENSE etc.:</p> <pre data-language="ruby">prefix.install_metafiles</pre> <p>Generally we‚Äôd rather you were specific about which files or directories need to be installed rather than installing everything.</p> <h4 id="variables-for-directory-locations">Variables for directory locations</h4> <table> <thead> <tr> <th>name</th> <th>default path</th> <th>example</th> </tr> </thead> <tbody> <tr> <td><strong><code class="language-plaintext highlighter-rouge">HOMEBREW_PREFIX</code></strong></td> <td>same as output of <code class="language-plaintext highlighter-rouge">$(brew --prefix)</code>
</td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">etc</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{HOMEBREW_PREFIX}/etc</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/etc</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">pkgetc</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{HOMEBREW_PREFIX}/etc/#{name}</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/etc/foo</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">var</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{HOMEBREW_PREFIX}/var</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/var</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">prefix</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{HOMEBREW_PREFIX}/Cellar/#{name}/#{version}</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/Cellar/foo/0.1</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">opt_prefix</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{HOMEBREW_PREFIX}/opt/#{name}</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/opt/foo</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">bin</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{prefix}/bin</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/Cellar/foo/0.1/bin</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">opt_bin</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{opt_prefix}/bin</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/opt/foo/bin</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">doc</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{prefix}/share/doc/#{name}</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/Cellar/foo/0.1/share/doc/foo</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">include</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{prefix}/include</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/Cellar/foo/0.1/include</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">opt_include</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{opt_prefix}/include</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/opt/foo/include</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">info</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{prefix}/share/info</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/Cellar/foo/0.1/share/info</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">lib</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{prefix}/lib</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/Cellar/foo/0.1/lib</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">opt_lib</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{opt_prefix}/lib</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/opt/foo/lib</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">libexec</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{prefix}/libexec</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/Cellar/foo/0.1/libexec</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">opt_libexec</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{opt_prefix}/libexec</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/opt/foo/libexec</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">man</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{prefix}/share/man</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/Cellar/foo/0.1/share/man</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">man[1-8]</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{prefix}/share/man/man[1-8]</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/Cellar/foo/0.1/share/man/man[1-8]</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">sbin</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{prefix}/sbin</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/Cellar/foo/0.1/sbin</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">opt_sbin</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{opt_prefix}/sbin</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/opt/foo/sbin</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">share</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{prefix}/share</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/Cellar/foo/0.1/share</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">opt_share</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{opt_prefix}/share</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/opt/foo/share</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">pkgshare</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{prefix}/share/#{name}</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/Cellar/foo/0.1/share/foo</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">opt_pkgshare</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{opt_prefix}/share/#{name}</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/opt/foo/share/foo</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">elisp</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{prefix}/share/emacs/site-lisp/#{name}</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/Cellar/foo/0.1/share/emacs/site-lisp/foo</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">opt_elisp</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{opt_prefix}/share/emacs/site-lisp/#{name}</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/opt/foo/share/emacs/site-lisp/foo</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">frameworks</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{prefix}/Frameworks</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/Cellar/foo/0.1/Frameworks</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">opt_frameworks</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{opt_prefix}/Frameworks</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/opt/foo/Frameworks</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">kext_prefix</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{prefix}/Library/Extensions</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/Cellar/foo/0.1/Library/Extensions</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">bash_completion</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{prefix}/etc/bash_completion.d</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/Cellar/foo/0.1/etc/bash_completion.d</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">fish_completion</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{prefix}/share/fish/vendor_completions.d</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/Cellar/foo/0.1/share/fish/vendor_completions.d</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">fish_function</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{prefix}/share/fish/vendor_functions.d</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/Cellar/foo/0.1/share/fish/vendor_functions.d</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">zsh_completion</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{prefix}/share/zsh/site-functions</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/Cellar/foo/0.1/share/zsh/site-functions</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">zsh_function</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{prefix}/share/zsh/site-functions</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/Cellar/foo/0.1/share/zsh/site-functions</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">pwsh_completion</code></strong></td> <td><code class="language-plaintext highlighter-rouge">#{prefix}/share/pwsh/completions</code></td> <td><code class="language-plaintext highlighter-rouge">/opt/homebrew/Cellar/foo/0.1/share/pwsh/completions</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">buildpath</code></strong></td> <td>temporary working directory during builds</td> <td><code class="language-plaintext highlighter-rouge">/private/tmp/foo-20250205-69197-po5981/foo-0.1</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">testpath</code></strong></td> <td>temporary working directory during tests</td> <td><code class="language-plaintext highlighter-rouge">/private/tmp/foo-test-20250205-84567-4hfs9m</code></td> </tr> </tbody> </table> <p>These can be used, for instance, in code such as:</p> <pre data-language="ruby">bin.install Dir["output/*"]</pre> <p>to move binaries into their correct location within the Cellar, and:</p> <pre data-language="ruby">man.mkpath</pre> <p>to create the directory structure for the manual page location.</p> <p>To install man pages into specific locations, use <code class="language-plaintext highlighter-rouge">man1.install "foo.1", "bar.1"</code>, <code class="language-plaintext highlighter-rouge">man2.install "foo.2"</code>, etc.</p> <p>The <code class="language-plaintext highlighter-rouge">opt_</code> variants generate paths that are stable between updates, which can be useful for e.g. replacing versioned paths in files:</p> <pre data-language="ruby">inreplace lib/"pkgconfig/zlib.pc", prefix, opt_prefix</pre> <p>Note that in the context of Homebrew, <a href="https://rubydoc.brew.sh/Formula#libexec-instance_method"><code class="language-plaintext highlighter-rouge">libexec</code></a> is reserved for private use by the formula and therefore is not symlinked into <code class="language-plaintext highlighter-rouge">HOMEBREW_PREFIX</code>.</p> <h3 id="file-level-operations">File-level operations</h3> <p>You can use the file utilities provided by Ruby‚Äôs <a href="https://ruby-doc.org/current/stdlibs/fileutils/FileUtils.html"><code class="language-plaintext highlighter-rouge">FileUtils</code></a>. These are included in the <a href="https://rubydoc.brew.sh/Formula"><code class="language-plaintext highlighter-rouge">Formula</code> class</a>, so you do not need the <code class="language-plaintext highlighter-rouge">FileUtils.</code> prefix to use them.</p> <p>When creating symlinks, take special care to ensure they are <em>relative</em> symlinks. This makes it easier to create a relocatable bottle. For example, to create a symlink in <code class="language-plaintext highlighter-rouge">bin</code> to an executable in <code class="language-plaintext highlighter-rouge">libexec</code>, use:</p> <pre data-language="ruby">bin.install_symlink libexec/"name"</pre> <p>instead of:</p> <pre data-language="ruby">ln_s libexec/"name", bin</pre> <p>The symlinks created by <a href="https://rubydoc.brew.sh/Pathname#install_symlink-instance_method"><code class="language-plaintext highlighter-rouge">install_symlink</code></a> are guaranteed to be relative. <code class="language-plaintext highlighter-rouge">ln_s</code> will only produce a relative symlink when given a relative path.</p> <p>Several other utilities for Ruby‚Äôs <a href="https://rubydoc.brew.sh/Pathname"><code class="language-plaintext highlighter-rouge">Pathname</code></a> can simplify some common operations.</p> <ul> <li>To perform several operations within a directory, enclose them within a <a href="https://rubydoc.brew.sh/Pathname#cd-instance_method"><code class="language-plaintext highlighter-rouge">cd &lt;path&gt; do</code></a> block:</li> </ul> <pre data-language="ruby">cd "src" do
  system "./configure", "--disable-debug", "--prefix=#{prefix}"
  system "make", "install"
end</pre> <ul> <li>To surface one or more binaries buried in <code class="language-plaintext highlighter-rouge">libexec</code> or a macOS <code class="language-plaintext highlighter-rouge">.app</code> package, use <a href="https://rubydoc.brew.sh/Pathname#write_exec_script-instance_method"><code class="language-plaintext highlighter-rouge">write_exec_script</code></a> or <a href="https://rubydoc.brew.sh/Pathname#write_jar_script-instance_method"><code class="language-plaintext highlighter-rouge">write_jar_script</code></a>:</li> </ul> <pre data-language="ruby">bin.write_exec_script Dir[libexec/"bin/*"]
bin.write_exec_script prefix/"Package.app/Contents/MacOS/package"
bin.write_jar_script libexec/jar_file, "jarfile", java_version: "11"</pre> <ul> <li>For binaries that require setting one or more environment variables to function properly, use <a href="https://rubydoc.brew.sh/Pathname#write_env_script-instance_method"><code class="language-plaintext highlighter-rouge">write_env_script</code></a> or <a href="https://rubydoc.brew.sh/Pathname#env_script_all_files-instance_method"><code class="language-plaintext highlighter-rouge">env_script_all_files</code></a>:</li> </ul> <pre data-language="ruby">(bin/"package").write_env_script libexec/"package", PACKAGE_ROOT: libexec
bin.env_script_all_files(libexec/"bin", PERL5LIB: ENV.fetch("PERL5LIB", nil))</pre> <h3 id="rewriting-a-script-shebang">Rewriting a script shebang</h3> <p>Some formulae install executable scripts written in an interpreted language such as Python or Perl. Homebrew provides a <code class="language-plaintext highlighter-rouge">rewrite_shebang</code> method to rewrite the shebang of a script. This replaces a script‚Äôs original interpreter path with the one the formula depends on. This guarantees that the correct interpreter is used at execution time. This isn‚Äôt required if the build system already handles it (e.g. often with <code class="language-plaintext highlighter-rouge">pip</code> or Perl <code class="language-plaintext highlighter-rouge">ExtUtils::MakeMaker</code>).</p> <p>For example, the <a href="https://github.com/Homebrew/homebrew-core/blob/bc311e91f3a77889e568dec8d3063c3a6cb2965a/Formula/i/icdiff.rb#L18"><code class="language-plaintext highlighter-rouge">icdiff</code></a> formula uses this utility. Note that it is necessary to include the utility in the formula; for example with Python one must use <code class="language-plaintext highlighter-rouge">include Language::Python::Shebang</code>.</p> <h3 id="adding-optional-steps">Adding optional steps</h3> <p><strong>Note:</strong> <a href="https://rubydoc.brew.sh/Formula#option-class_method"><code class="language-plaintext highlighter-rouge">option</code></a>s are not allowed in Homebrew/homebrew-core as they are not tested by CI.</p> <p>If you want to add an <a href="https://rubydoc.brew.sh/Formula#option-class_method"><code class="language-plaintext highlighter-rouge">option</code></a>:</p> <pre data-language="ruby">class Yourformula &lt; Formula
  # ...
  url "https://example.com/yourformula-1.0.tar.gz"
  sha256 "abc123abc123abc123abc123abc123abc123abc123abc123abc123abc123abc1"
  # ...
  option "with-ham", "Description of the option"
  option "without-spam", "Another description"

  depends_on "bar" =&gt; :recommended
  depends_on "foo" =&gt; :optional # automatically adds a with-foo option # automatically adds a without-bar option
  # ...
end</pre> <p>And then to define the effects the <a href="https://rubydoc.brew.sh/Formula#option-class_method"><code class="language-plaintext highlighter-rouge">option</code></a>s have:</p> <pre data-language="ruby">if build.with? "ham"
  # note, no "with" in the option name (it is added by the build.with? method)
end

if build.without? "ham"
  # works as you'd expect. True if `--without-ham` was given.
end</pre> <p><a href="https://rubydoc.brew.sh/Formula#option-class_method"><code class="language-plaintext highlighter-rouge">option</code></a> names should be prefixed with the words <code class="language-plaintext highlighter-rouge">with</code> or <code class="language-plaintext highlighter-rouge">without</code>. For example, an option to run a test suite should be named <code class="language-plaintext highlighter-rouge">--with-test</code> or <code class="language-plaintext highlighter-rouge">--with-check</code> rather than <code class="language-plaintext highlighter-rouge">--test</code>, and an option to enable a shared library <code class="language-plaintext highlighter-rouge">--with-shared</code> rather than <code class="language-plaintext highlighter-rouge">--shared</code> or <code class="language-plaintext highlighter-rouge">--enable-shared</code>. See the <a href="https://github.com/homebrew-ffmpeg/homebrew-ffmpeg/blob/HEAD/Formula/ffmpeg.rb">alternative <code class="language-plaintext highlighter-rouge">ffmpeg</code></a> formula for examples.</p> <p><a href="https://rubydoc.brew.sh/Formula#option-class_method"><code class="language-plaintext highlighter-rouge">option</code></a>s that aren‚Äôt <code class="language-plaintext highlighter-rouge">build.with?</code> or <code class="language-plaintext highlighter-rouge">build.without?</code> should be deprecated with <a href="https://rubydoc.brew.sh/Formula#deprecated_option-class_method"><code class="language-plaintext highlighter-rouge">deprecated_option</code></a>. See the <a href="https://github.com/Homebrew/homebrew-core/blob/3f762b63c6fbbd49191ffdf58574d7e18937d93f/Formula/wget.rb#L27-L31"><code class="language-plaintext highlighter-rouge">wget</code></a> formula for a historical example.</p> <h3 id="running-commands-after-installation">Running commands after installation</h3> <p>Any initialization steps that aren‚Äôt necessarily part of the install process can be located in a <code class="language-plaintext highlighter-rouge">post_install</code> block, such as setup commands or data directory creation. This block can be re-run separately with <code class="language-plaintext highlighter-rouge">brew postinstall &lt;formula&gt;</code>.</p> <pre data-language="ruby">class Foo &lt; Formula
  # ...
  url "https://example.com/foo-1.0.tar.gz"

  def post_install
    rm pkgetc/"cert.pem" if File.exist?(pkgetc/"cert.pem")
    pkgetc.install_symlink Formula["ca-certificates"].pkgetc/"cert.pem"
  end
  # ...
end</pre> <p>In the above example, the <a href="https://github.com/Homebrew/homebrew-core/blob/442f9cc511ce6dfe75b96b2c83749d90dde914d2/Formula/lib/libressl.rb#L53-L56"><code class="language-plaintext highlighter-rouge">libressl</code></a> formula replaces its stock list of certificates with a symlink to that of the <code class="language-plaintext highlighter-rouge">ca-certificates</code> formula.</p> <h3 id="handling-files-that-should-persist-over-formula-upgrades">Handling files that should persist over formula upgrades</h3> <p>For example, Ruby 1.9‚Äôs gems should be installed to <code class="language-plaintext highlighter-rouge">var/lib/ruby/</code> so that gems don‚Äôt need to be reinstalled when upgrading Ruby. You can usually do this with symlink trickery, or (ideally) a configure option.</p> <p>Another example would be configuration files that should not be overwritten on package upgrades. If after installation you find that to-be-persisted configuration files are not copied but instead <em>symlinked</em> into <code class="language-plaintext highlighter-rouge">$(brew --prefix)/etc/</code> from the Cellar, this can often be rectified by passing an appropriate argument to the package‚Äôs configure script. That argument will vary depending on a given package‚Äôs configure script and/or Makefile, but one example might be: <code class="language-plaintext highlighter-rouge">--sysconfdir=#{etc}</code></p> <h3 id="service-files">Service files</h3> <p>There are two ways to add <code class="language-plaintext highlighter-rouge">launchd</code> plists and <code class="language-plaintext highlighter-rouge">systemd</code> services to a formula, so that <code class="language-plaintext highlighter-rouge">brew services</code> can pick them up:</p> <ol> <li>If the package already provides a service file the formula can reference it by name:</li> </ol> <pre data-language="ruby">service do
  name macos: "custom.launchd.name",
       linux: "custom.systemd.name"
end</pre> <p>To find the file we append <code class="language-plaintext highlighter-rouge">.plist</code> to the <code class="language-plaintext highlighter-rouge">launchd</code> service name and <code class="language-plaintext highlighter-rouge">.service</code> to the <code class="language-plaintext highlighter-rouge">systemd</code> service name internally.</p> <ol> <li>If the formula does not provide a service file you can generate one using the following stanza:</li> </ol> <pre data-language="ruby"># 1. An individual command
service do
  run opt_bin/"script"
end

# 2. A command with arguments
service do
  run [opt_bin/"script", "--config", etc/"dir/config.yml"]
end

# 3. OS specific commands (If you omit one, the service file won't get generated for that OS.)
service do
  run macos: [opt_bin/"macos_script", "standalone"],
      linux: var/"special_linux_script"
end</pre> <h4 id="service-block-methods">Service block methods</h4> <p>This table lists the options you can set within a <code class="language-plaintext highlighter-rouge">service</code> block. The <code class="language-plaintext highlighter-rouge">run</code> or <code class="language-plaintext highlighter-rouge">name</code> field must be defined inside the service block. If <code class="language-plaintext highlighter-rouge">name</code> is defined without <code class="language-plaintext highlighter-rouge">run</code>, then Homebrew makes no attempt to change the package-provided service file according these fields. The <code class="language-plaintext highlighter-rouge">run</code> field indicates what command to run, instructs Homebrew to create a service description file using options set in the block, and therefore is required before using fields other than <code class="language-plaintext highlighter-rouge">name</code> and <code class="language-plaintext highlighter-rouge">require_root</code>.</p> <table> <thead> <tr> <th>method</th> <th>default</th> <th style="text-align: center">macOS</th> <th style="text-align: center">Linux</th> <th>description</th> </tr> </thead> <tbody> <tr> <td><code class="language-plaintext highlighter-rouge">run</code></td> <td>-</td> <td style="text-align: center">yes</td> <td style="text-align: center">yes</td> <td>command to execute: an array with arguments or a path</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">run_type</code></td> <td><code class="language-plaintext highlighter-rouge">:immediate</code></td> <td style="text-align: center">yes</td> <td style="text-align: center">yes</td> <td>type of service: <code class="language-plaintext highlighter-rouge">:immediate</code>, <code class="language-plaintext highlighter-rouge">:interval</code> or <code class="language-plaintext highlighter-rouge">:cron</code>
</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">interval</code></td> <td>-</td> <td style="text-align: center">yes</td> <td style="text-align: center">yes</td> <td>controls the start interval, required for the <code class="language-plaintext highlighter-rouge">:interval</code> type</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">cron</code></td> <td>-</td> <td style="text-align: center">yes</td> <td style="text-align: center">yes</td> <td>controls the trigger times, required for the <code class="language-plaintext highlighter-rouge">:cron</code> type</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">keep_alive</code></td> <td><code class="language-plaintext highlighter-rouge">false</code></td> <td style="text-align: center">yes</td> <td style="text-align: center">yes</td> <td>
<a href="#keep_alive-options">sets contexts</a> in which the service will keep the process running</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">launch_only_once</code></td> <td><code class="language-plaintext highlighter-rouge">false</code></td> <td style="text-align: center">yes</td> <td style="text-align: center">yes</td> <td>whether the command should only run once</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">require_root</code></td> <td><code class="language-plaintext highlighter-rouge">false</code></td> <td style="text-align: center">yes</td> <td style="text-align: center">yes</td> <td>whether the service requires root access. If true, Homebrew hints at using <code class="language-plaintext highlighter-rouge">sudo</code> on various occasions, but does not enforce it</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">environment_variables</code></td> <td>-</td> <td style="text-align: center">yes</td> <td style="text-align: center">yes</td> <td>hash of variables to set</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">working_dir</code></td> <td>-</td> <td style="text-align: center">yes</td> <td style="text-align: center">yes</td> <td>directory to operate from</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">root_dir</code></td> <td>-</td> <td style="text-align: center">yes</td> <td style="text-align: center">yes</td> <td>directory to use as a chroot for the process</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">input_path</code></td> <td>-</td> <td style="text-align: center">yes</td> <td style="text-align: center">yes</td> <td>path to use as input for the process</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">log_path</code></td> <td>-</td> <td style="text-align: center">yes</td> <td style="text-align: center">yes</td> <td>path to write <code class="language-plaintext highlighter-rouge">stdout</code> to</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">error_log_path</code></td> <td>-</td> <td style="text-align: center">yes</td> <td style="text-align: center">yes</td> <td>path to write <code class="language-plaintext highlighter-rouge">stderr</code> to</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">restart_delay</code></td> <td>-</td> <td style="text-align: center">yes</td> <td style="text-align: center">yes</td> <td>number of seconds to delay before restarting a process</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">process_type</code></td> <td>-</td> <td style="text-align: center">yes</td> <td style="text-align: center">no-op</td> <td>type of process to manage: <code class="language-plaintext highlighter-rouge">:background</code>, <code class="language-plaintext highlighter-rouge">:standard</code>, <code class="language-plaintext highlighter-rouge">:interactive</code> or <code class="language-plaintext highlighter-rouge">:adaptive</code>
</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">macos_legacy_timers</code></td> <td>-</td> <td style="text-align: center">yes</td> <td style="text-align: center">no-op</td> <td>timers created by <code class="language-plaintext highlighter-rouge">launchd</code> jobs are coalesced unless this is set</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">sockets</code></td> <td>-</td> <td style="text-align: center">yes</td> <td style="text-align: center">no-op</td> <td>socket that is created as an accesspoint to the service</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">name</code></td> <td>-</td> <td style="text-align: center">yes</td> <td style="text-align: center">yes</td> <td>a hash with the <code class="language-plaintext highlighter-rouge">launchd</code> service name on macOS and/or the <code class="language-plaintext highlighter-rouge">systemd</code> service name on Linux. Homebrew generates a default name for the service file if this is not present</td> </tr> </tbody> </table> <p>For services that are kept alive after starting you can use the default <code class="language-plaintext highlighter-rouge">run_type</code>:</p> <pre data-language="ruby">service do
  run [opt_bin/"beanstalkd", "test"]
  keep_alive true
  run_type :immediate # This should be omitted since it's the default
end</pre> <p>If a service needs to run on an interval, use <code class="language-plaintext highlighter-rouge">run_type :interval</code> and specify an interval:</p> <pre data-language="ruby">service do
  run [opt_bin/"beanstalkd", "test"]
  run_type :interval
  interval 500
end</pre> <p>If a service needs to run at certain times, use <code class="language-plaintext highlighter-rouge">run_type :cron</code> and specify a time with the crontab syntax:</p> <pre data-language="ruby">service do
  run [opt_bin/"beanstalkd", "test"]
  run_type :cron
  cron "5 * * * *"
end</pre> <p>Environment variables can be set with a hash. For the <code class="language-plaintext highlighter-rouge">PATH</code> there is the helper method <code class="language-plaintext highlighter-rouge">std_service_path_env</code> which returns <code class="language-plaintext highlighter-rouge">#{HOMEBREW_PREFIX}/bin:#{HOMEBREW_PREFIX}/sbin:/usr/bin:/bin:/usr/sbin:/sbin</code> so the service can find other <code class="language-plaintext highlighter-rouge">brew</code>-installed commands.</p> <pre data-language="ruby">service do
  run opt_bin/"beanstalkd"
  environment_variables PATH: std_service_path_env
end</pre> <h4 id="keep_alive-options">
<code class="language-plaintext highlighter-rouge">keep_alive</code> options</h4> <p>The standard options keep the service alive regardless of any status or circumstances:</p> <pre data-language="ruby">service do
  run [opt_bin/"beanstalkd", "test"]
  keep_alive true # or false
end</pre> <p>Same as above in hash form:</p> <pre data-language="ruby">service do
  run [opt_bin/"beanstalkd", "test"]
  keep_alive always: true
end</pre> <p>Keep alive until the service exits with a non-zero return code:</p> <pre data-language="ruby">service do
  run [opt_bin/"beanstalkd", "test"]
  keep_alive successful_exit: true
end</pre> <p>Keep alive only if the job crashed:</p> <pre data-language="ruby">service do
  run [opt_bin/"beanstalkd", "test"]
  keep_alive crashed: true
end</pre> <p>Keep alive as long as a file exists:</p> <pre data-language="ruby">service do
  run [opt_bin/"beanstalkd", "test"]
  keep_alive path: "/some/path"
end</pre> <h4 id="sockets-format">
<code class="language-plaintext highlighter-rouge">sockets</code> format</h4> <p>The <code class="language-plaintext highlighter-rouge">sockets</code> method accepts a formatted socket definition as <code class="language-plaintext highlighter-rouge">&lt;type&gt;://&lt;host&gt;:&lt;port&gt;</code>.</p> <ul> <li>
<code class="language-plaintext highlighter-rouge">type</code>: <code class="language-plaintext highlighter-rouge">udp</code> or <code class="language-plaintext highlighter-rouge">tcp</code>
</li> <li>
<code class="language-plaintext highlighter-rouge">host</code>: host to run the socket on, e.g. <code class="language-plaintext highlighter-rouge">0.0.0.0</code>
</li> <li>
<code class="language-plaintext highlighter-rouge">port</code>: port number the socket should listen on</li> </ul> <p>Please note that sockets will be accessible on IPv4 and IPv6 addresses by default.</p> <p>If you only need one socket and you don‚Äôt care about the name (the default is <code class="language-plaintext highlighter-rouge">listeners</code>):</p> <pre data-language="rb">service do
  run [opt_bin/"beanstalkd", "test"]
  sockets "tcp://127.0.0.1:80"
end</pre> <p>If you need multiple sockets and/or you want to specify the name:</p> <pre data-language="rb">service do
  run [opt_bin/"beanstalkd", "test"]
  sockets http: "tcp://0.0.0.0:80", https: "tcp://0.0.0.0:443"
end</pre> <h3 id="using-environment-variables">Using environment variables</h3> <p>Homebrew has multiple levels of environment variable filtering which affects which variables are available to formulae.</p> <p>Firstly, the overall <a href="https://github.com/Homebrew/brew/issues/932">environment in which Homebrew runs is filtered</a> to avoid environment contamination breaking from-source builds. In particular, this process filters all but a select list of variables, plus allowing any prefixed with <code class="language-plaintext highlighter-rouge">HOMEBREW_</code>. The specific implementation is found in <a href="https://github.com/Homebrew/brew/blob/HEAD/bin/brew"><code class="language-plaintext highlighter-rouge">bin/brew</code></a>.</p> <p>The second level of filtering <a href="https://github.com/Homebrew/brew/pull/2524">removes sensitive environment variables</a> (such as credentials like keys, passwords or tokens) to prevent malicious subprocesses from obtaining them. This has the effect of preventing any such variables from reaching a formula‚Äôs Ruby code since they are filtered before it is called. The specific implementation is found in the <a href="https://github.com/Homebrew/brew/blob/HEAD/Library/Homebrew/extend/ENV.rb"><code class="language-plaintext highlighter-rouge">ENV.clear_sensitive_environment!</code> method</a>.</p> <p>In summary, any environment variables intended for use by a formula need to conform to these filtering rules in order to be available.</p> <h4 id="setting-environment-variables-during-installation">Setting environment variables during installation</h4> <p>You can set environment variables in a formula‚Äôs <code class="language-plaintext highlighter-rouge">install</code> or <code class="language-plaintext highlighter-rouge">test</code> blocks using <code class="language-plaintext highlighter-rouge">ENV["VARIABLE_NAME"] = "VALUE"</code>. An example can be seen in the <a href="https://github.com/Homebrew/homebrew-core/blob/442f9cc511ce6dfe75b96b2c83749d90dde914d2/Formula/c/csound.rb#L96"><code class="language-plaintext highlighter-rouge">csound</code></a> formula.</p> <p>Environment variables can also be set temporarily using the <code class="language-plaintext highlighter-rouge">with_env</code> method; any variables defined in the call to that method will be restored to their original values at the end of the block. An example can be seen in the <a href="https://github.com/Homebrew/homebrew-core/blob/1fd795861004bdf8bc5f6687c58b76c674794d40/Formula/g/gh.rb#L28-L33"><code class="language-plaintext highlighter-rouge">gh</code></a> formula.</p> <p>There are also <code class="language-plaintext highlighter-rouge">ENV</code> helper methods available for many common environment variable setting and retrieval operations, such as:</p> <ul> <li>
<code class="language-plaintext highlighter-rouge">ENV.cxx11</code> - compile with C++11 features enabled</li> <li>
<code class="language-plaintext highlighter-rouge">ENV.deparallelize</code> - compile with only one job at a time; pass a block to have it only influence specific install steps</li> <li>
<code class="language-plaintext highlighter-rouge">ENV.O0</code>, <code class="language-plaintext highlighter-rouge">ENV.O1</code>, <code class="language-plaintext highlighter-rouge">ENV.O3</code> - set a specific compiler optimization level (<em>default:</em> macOS: <code class="language-plaintext highlighter-rouge">-Os</code>, Linux: <code class="language-plaintext highlighter-rouge">-O2</code>)</li> <li>
<code class="language-plaintext highlighter-rouge">ENV.runtime_cpu_detection</code> - account for formulae that detect CPU features at runtime</li> <li>
<code class="language-plaintext highlighter-rouge">ENV.append_to_cflags</code> - add a value to <code class="language-plaintext highlighter-rouge">CFLAGS</code> <code class="language-plaintext highlighter-rouge">CXXFLAGS</code> <code class="language-plaintext highlighter-rouge">OBJCFLAGS</code> <code class="language-plaintext highlighter-rouge">OBJCXXFLAGS</code> all at once</li> <li>
<code class="language-plaintext highlighter-rouge">ENV.prepend_create_path</code> - create and prepend a path to an existing list of paths</li> <li>
<code class="language-plaintext highlighter-rouge">ENV.remove</code> - remove a string from an environment variable value</li> <li>
<code class="language-plaintext highlighter-rouge">ENV.delete</code> - unset an environment variable</li> </ul> <p>The full list can be found in the <a href="https://rubydoc.brew.sh/SharedEnvExtension"><code class="language-plaintext highlighter-rouge">SharedEnvExtension</code> module</a> and <a href="https://rubydoc.brew.sh/Superenv"><code class="language-plaintext highlighter-rouge">Superenv</code> module</a> documentation.</p> <h3 id="deprecating-and-disabling-a-formula">Deprecating and disabling a formula</h3> <p>See our <a href="deprecating-disabling-and-removing-formulae">Deprecating, Disabling and Removing Formulae</a> documentation for more information about how and when to deprecate or disable a formula.</p> <h2 id="updating-formulae">Updating formulae</h2> <p>When a new version of the software is released, use <code class="language-plaintext highlighter-rouge">brew bump-formula-pr</code> to automatically update the <a href="https://rubydoc.brew.sh/Formula#url-class_method"><code class="language-plaintext highlighter-rouge">url</code></a> and <a href="https://rubydoc.brew.sh/Formula#sha256-class_method"><code class="language-plaintext highlighter-rouge">sha256</code></a>, remove any <a href="https://rubydoc.brew.sh/Formula#revision-class_method"><code class="language-plaintext highlighter-rouge">revision</code></a> lines, and submit a pull request. See our <a href="how-to-open-a-homebrew-pull-request">How to Open a Homebrew Pull Request</a> documentation for more information.</p> <h2 id="troubleshooting-for-new-formulae">Troubleshooting for new formulae</h2> <h3 id="version-detection-failures">Version detection failures</h3> <p>Homebrew tries to automatically determine the <a href="https://rubydoc.brew.sh/Formula#version-class_method"><code class="language-plaintext highlighter-rouge">version</code></a> from the <a href="https://rubydoc.brew.sh/Formula#url-class_method"><code class="language-plaintext highlighter-rouge">url</code></a> to avoid duplication. If the tarball has an unusual name you may need to manually assign the <a href="https://rubydoc.brew.sh/Formula#version-class_method"><code class="language-plaintext highlighter-rouge">version</code></a>.</p> <h3 id="bad-makefiles">Bad makefiles</h3> <p>If a project‚Äôs makefile will not run in parallel, try to deparallelize by adding these lines to the formula‚Äôs <code class="language-plaintext highlighter-rouge">install</code> method:</p> <pre data-language="ruby">ENV.deparallelize
system "make" # separate compilation and installation steps
system "make", "install"</pre> <p>If that fixes it, please open an issue with the upstream project so that we can fix it for everyone.</p> <h3 id="still-wont-work">Still won‚Äôt work?</h3> <p>Check out what MacPorts and Fink do:</p> <pre data-language="bash">brew search --macports foo
brew search --fink foo</pre> <h3 id="superenv-notes">Superenv notes</h3> <p><code class="language-plaintext highlighter-rouge">superenv</code> is our ‚Äúsuper environment‚Äù that isolates builds by removing <code class="language-plaintext highlighter-rouge">/usr/local/bin</code> and all user <code class="language-plaintext highlighter-rouge">PATH</code>s that are not essential for the build. It does this because user <code class="language-plaintext highlighter-rouge">PATH</code>s are often full of stuff that breaks builds. <code class="language-plaintext highlighter-rouge">superenv</code> also removes bad flags from the commands passed to <code class="language-plaintext highlighter-rouge">clang</code>/<code class="language-plaintext highlighter-rouge">gcc</code> and injects others (for example all <a href="https://rubydoc.brew.sh/Formula#keg_only-class_method"><code class="language-plaintext highlighter-rouge">keg_only</code></a> dependencies are added to the <code class="language-plaintext highlighter-rouge">-I</code> and <code class="language-plaintext highlighter-rouge">-L</code> flags).</p> <p>If in your local Homebrew build of your new formula, you see <code class="language-plaintext highlighter-rouge">Operation not permitted</code> errors, this will be because your new formula tried to write to the disk outside of your sandbox area. This is enforced on macOS by <code class="language-plaintext highlighter-rouge">sandbox-exec</code>.</p> <h3 id="fortran">Fortran</h3> <p>Some software requires a Fortran compiler. This can be declared by adding <code class="language-plaintext highlighter-rouge">depends_on "gcc"</code> to a formula.</p> <h3 id="mpi">MPI</h3> <p>Packages requiring MPI should use <a href="https://www.open-mpi.org/">OpenMPI</a> by adding <code class="language-plaintext highlighter-rouge">depends_on "open-mpi"</code> to the formula, rather than <a href="https://www.mpich.org/">MPICH</a>. These packages have conflicts and provide the same standardised interfaces. Choosing a default implementation and requiring its adoption allows software to link against multiple libraries that rely on MPI without creating unanticipated incompatibilities due to differing MPI runtimes.</p> <h3 id="linear-algebra-libraries">Linear algebra libraries</h3> <p>Packages requiring BLAS/LAPACK linear algebra interfaces should link to <a href="https://www.openblas.net/">OpenBLAS</a> by adding <code class="language-plaintext highlighter-rouge">depends_on "openblas"</code> and (if built with CMake) passing <code class="language-plaintext highlighter-rouge">-DBLA_VENDOR=OpenBLAS</code> to CMake, rather than Apple‚Äôs Accelerate framework or the default reference <code class="language-plaintext highlighter-rouge">lapack</code> implementation. Apple‚Äôs implementation of BLAS/LAPACK is outdated and may introduce hard-to-debug problems. The reference <code class="language-plaintext highlighter-rouge">lapack</code> formula is fine, although it is not actively maintained or tuned.</p> <h2 id="how-to-start-over-reset-to-upstream">How to start over (reset to upstream)</h2> <p>Have you created a real mess in Git which stops you from creating a commit you want to submit to us? You might want to consider starting again from scratch. Your changes to the Homebrew <code class="language-plaintext highlighter-rouge">main</code> branch can be reset by running:</p> <pre data-language="bash">git checkout -f main
git reset --hard origin/HEAD</pre><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2009&ndash;present Homebrew contributors<br>Licensed under the BSD 2-Clause License.<br>
    <a href="https://docs.brew.sh/Formula-Cookbook" class="_attribution-link">https://docs.brew.sh/Formula-Cookbook</a>
  </p>
</div>
