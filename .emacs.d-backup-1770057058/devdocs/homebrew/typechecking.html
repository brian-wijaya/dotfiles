<h1 id="type-checking-with-sorbet">Type Checking With Sorbet</h1> <p>The majority of the code in Homebrew is written in Ruby which is a dynamic language. To avail the benefits of static type checking, we have set up <a href="https://sorbet.org/">Sorbet</a> in our codebase which provides the benefits of static type checking to dynamic languages like Ruby.</p> <p>The <a href="https://sorbet.org/docs/overview">Sorbet Documentation</a> is a good place to get started if you want to dive deeper into Sorbet and its abilities.</p> <h2 id="sorbet-in-the-homebrew-codebase">Sorbet in the Homebrew Codebase</h2> <h3 id="inline-type-annotations">Inline type annotations</h3> <p>The <code class="language-plaintext highlighter-rouge">sig</code> method is used to annotate method signatures. Here’s a simple example:</p> <pre data-language="ruby">class MyClass
  sig { params(name: String).returns(String) }
  def my_method(name)
    "Hello, #{name}!"
  end
end</pre> <p>With <code class="language-plaintext highlighter-rouge">params</code> we specify that there is a parameter <code class="language-plaintext highlighter-rouge">name</code> which must be a <code class="language-plaintext highlighter-rouge">String</code>, and with <code class="language-plaintext highlighter-rouge">returns</code> we specify that this method always returns a <code class="language-plaintext highlighter-rouge">String</code>.</p> <p>For more information on how to express more complex types, refer to the official documentation:</p> <ul> <li><a href="https://sorbet.org/docs/sigs">Method Signatures</a></li> <li><a href="https://sorbet.org/docs/class-types">Class Types</a></li> <li><a href="https://sorbet.org/docs/nilable-types">Nilable Types</a></li> <li><a href="https://sorbet.org/docs/union-types">Union Types</a></li> </ul> <h3 id="ruby-interface-files-rbi">Ruby interface files (<code class="language-plaintext highlighter-rouge">.rbi</code>)</h3> <p><a href="https://sorbet.org/docs/rbi">RBI files</a> help Sorbet learn about constants, ancestors and methods defined in ways it doesn’t understand natively. We can also create an RBI file to help Sorbet understand dynamic definitions. Some of these files are automatically generated (see the next section) and some are manually written, e.g. <a href="https://github.com/Homebrew/brew/blob/HEAD/Library/Homebrew/on_system.rbi"><code class="language-plaintext highlighter-rouge">on_system.rbi</code></a>.</p> <p>There are also a very small number of files that Homebrew loads before <code class="language-plaintext highlighter-rouge">sorbet-runtime</code>, such as <code class="language-plaintext highlighter-rouge">utils/gems.rb</code>. Those files cannot have type signatures alongside the code itself, so RBI files are used there instead to retain static type checking.</p> <h3 id="the-libraryhomebrewsorbet-directory">The <a href="https://github.com/Homebrew/brew/tree/HEAD/Library/Homebrew/sorbet"><code class="language-plaintext highlighter-rouge">Library/Homebrew/sorbet</code></a> directory</h3> <p>The <code class="language-plaintext highlighter-rouge">rbi</code> directory contains all Ruby Interface (<code class="language-plaintext highlighter-rouge">.rbi</code>) files auto-generated by running <code class="language-plaintext highlighter-rouge">brew typecheck --update</code>:</p> <ul> <li>
<code class="language-plaintext highlighter-rouge">gems</code>: RBI files for all gems are generated using <a href="https://github.com/Shopify/tapioca#tapioca">Tapioca</a>.</li> <li>
<code class="language-plaintext highlighter-rouge">dsl</code>: RBI files auto-generated by our <a href="https://github.com/Homebrew/brew/tree/HEAD/Library/Homebrew/sorbet/tapioca/compilers">Tapioca compilers</a>.</li> <li>
<code class="language-plaintext highlighter-rouge">upstream.rbi</code>: This file is manually written and contains temporary workarounds for upstream Sorbet issues. It is typically empty.</li> </ul> <p>The <code class="language-plaintext highlighter-rouge">tapioca</code> directory contains configuration files and compilers for Tapioca, allowing Sorbet to type check the dynamically generated components of the codebase.</p> <p>The <code class="language-plaintext highlighter-rouge">config</code> file is a newline-separated list of arguments to pass to <code class="language-plaintext highlighter-rouge">srb tc</code>, the same as if they’d been passed on the command line. Arguments in the config file are always passed first, followed by arguments provided on the command line. We use it to ignore e.g. gem directories which we do not wish to type check.</p> <h2 id="using-brew-typecheck">Using <code class="language-plaintext highlighter-rouge">brew typecheck</code>
</h2> <p>Every Ruby file in the codebase has a magic <code class="language-plaintext highlighter-rouge"># typed: &lt;level&gt;</code> comment at the top, where <code class="language-plaintext highlighter-rouge">&lt;level&gt;</code> is one of <a href="https://sorbet.org/docs/static#file-level-granularity-strictness-levels">Sorbet’s strictness levels</a>, usually <code class="language-plaintext highlighter-rouge">false</code>, <code class="language-plaintext highlighter-rouge">true</code> or <code class="language-plaintext highlighter-rouge">strict</code>. The <code class="language-plaintext highlighter-rouge">false</code> files only report errors related to the syntax, constant resolution and correctness of the method signatures, but no type errors. Our long-term goal is to move all <code class="language-plaintext highlighter-rouge">false</code> files to <code class="language-plaintext highlighter-rouge">true</code> and start reporting type errors on those files as well. Therefore, when adding new files, you should ideally mark it with <code class="language-plaintext highlighter-rouge"># typed: true</code> and work out any resulting type errors.</p> <p>When run without any arguments, <code class="language-plaintext highlighter-rouge">brew typecheck</code> will run considering the strictness levels set in each of the individual Ruby files in the core Homebrew codebase. However, when run on a specific file or directory, more errors may show up since Sorbet cannot resolve constants defined outside the scope of the specified file. These problems can be solved with RBI files. Currently <code class="language-plaintext highlighter-rouge">brew typecheck</code> provides <code class="language-plaintext highlighter-rouge">--quiet</code>, <code class="language-plaintext highlighter-rouge">--file</code>, <code class="language-plaintext highlighter-rouge">--dir</code> and <code class="language-plaintext highlighter-rouge">--ignore</code> options, but you can explore more options with <code class="language-plaintext highlighter-rouge">srb tc --help</code> and pass them with <code class="language-plaintext highlighter-rouge">srb tc</code>.</p> <h2 id="resolving-type-errors">Resolving Type Errors</h2> <p>Sorbet reports type errors along with an error reference code, which can be used to look up more information on how to debug the error, or what causes the error in the <a href="https://sorbet.org/docs/overview">Sorbet Documentation</a>. Here’s how to debug some common type errors:</p> <ul> <li> <p>Using <code class="language-plaintext highlighter-rouge">T.reveal_type</code>: in files which are <code class="language-plaintext highlighter-rouge">true</code> or higher, by wrapping a variable or method call in <code class="language-plaintext highlighter-rouge">T.reveal_type</code>, Sorbet will show us what type it thinks that variable has in the output of <code class="language-plaintext highlighter-rouge">srb tc</code>. This is particularly useful when writing <a href="https://sorbet.org/docs/sigs">method signatures</a> and debugging. Make sure to remove this line from your code before committing your changes, since this is just a debugging tool.</p> </li> <li> <p>One of the most frequent errors that we’ve encountered is <code class="language-plaintext highlighter-rouge">7003: Method does not exist.</code> Since Ruby is a very dynamic language, methods can be defined in ways Sorbet cannot see statically. In such cases, check if the method exists at runtime; if not, then Sorbet has caught a future bug! But, it is also possible that even though a method exists at runtime, Sorbet cannot see it. In such cases, we use <a href="#ruby-interface-files-rbi"><code class="language-plaintext highlighter-rouge">.rbi</code> files</a>.</p> </li> <li> <p>Since Sorbet does not automatically assume that <code class="language-plaintext highlighter-rouge">Kernel</code> is to be included in modules, we may encounter many errors while trying to use methods like <code class="language-plaintext highlighter-rouge">puts</code>, <code class="language-plaintext highlighter-rouge">ohai</code>, <code class="language-plaintext highlighter-rouge">odebug</code> etc. There are generally two approaches to fixing this:</p> <ul> <li>If you are using <code class="language-plaintext highlighter-rouge">module_function</code> but never run <code class="language-plaintext highlighter-rouge">include ModuleName</code> anywhere, remove the <code class="language-plaintext highlighter-rouge">module_definition</code> and convert all methods to class methods (prepend the name with <code class="language-plaintext highlighter-rouge">self.</code>).</li> <li>If you do include the module elsewhere, add a <code class="language-plaintext highlighter-rouge">requires_ancestor</code> to the module defining what types of classes this module can be included in. This may be as simple as a <code class="language-plaintext highlighter-rouge">requires_ancestor { Kernel }</code>, which most classes are descended from.</li> </ul> </li> <li> <p>The tips above are very generic and apply to lots of cases. For some common gotchas when using Sorbet, refer to the <a href="https://sorbet.org/docs/error-reference">Sorbet Error Reference</a> and <a href="https://sorbet.org/docs/faq">FAQ</a>.</p> </li> </ul><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2009&ndash;present Homebrew contributors<br>Licensed under the BSD 2-Clause License.<br>
    <a href="https://docs.brew.sh/Typechecking" class="_attribution-link">https://docs.brew.sh/Typechecking</a>
  </p>
</div>
