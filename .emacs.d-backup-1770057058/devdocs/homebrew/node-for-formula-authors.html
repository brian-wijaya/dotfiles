<h1 id="node-for-formula-authors">Node for Formula Authors</h1> <p>This document explains how to successfully use Node and npm in a Node module based Homebrew formula.</p> <h2 id="running-npm-install">Running <code class="language-plaintext highlighter-rouge">npm install</code>
</h2> <p>Homebrew provides a helper method <code class="language-plaintext highlighter-rouge">std_npm_args</code> to set up the correct environment for npm and return arguments for <code class="language-plaintext highlighter-rouge">npm install</code>. Your formula should use this when invoking <code class="language-plaintext highlighter-rouge">npm install</code>. The syntax for a standard Node module installation is:</p> <pre data-language="ruby">system "npm", "install", *std_npm_args</pre> <h2 id="download-url">Download URL</h2> <p>If the Node module is also available on the npm registry, we prefer npm-hosted release tarballs over GitHub (or elsewhere) hosted source tarballs. The advantages of these tarballs are that they don’t include the files from the <code class="language-plaintext highlighter-rouge">.npmignore</code> (such as tests) resulting in a smaller download size and that any possible transpilation step is already done (e.g. no need to compile CoffeeScript files as a build step).</p> <p>The npm registry URLs usually have the format of:</p> <pre data-language="plaintext">https://registry.npmjs.org/&lt;name&gt;/-/&lt;name&gt;-&lt;version&gt;.tgz</pre> <p>Alternatively you could <code class="language-plaintext highlighter-rouge">curl</code> the JSON at <code class="language-plaintext highlighter-rouge">https://registry.npmjs.org/&lt;name&gt;</code> and look for the value of <code class="language-plaintext highlighter-rouge">versions[&lt;version&gt;].dist.tarball</code> for the correct tarball URL.</p> <h2 id="dependencies">Dependencies</h2> <p>Node modules which are compatible with the latest Node version should declare a dependency on the <code class="language-plaintext highlighter-rouge">node</code> formula.</p> <pre data-language="ruby">depends_on "node"</pre> <p>If your formula requires being executed with an older Node version you should use one of its versioned formulae (e.g. <code class="language-plaintext highlighter-rouge">node@20</code>).</p> <h3 id="special-requirements-for-native-addons">Special requirements for native addons</h3> <p>If your Node module is a native addon or has a native addon somewhere in its dependency tree you have to declare an additional dependency. Since the compilation of the native addon results in an invocation of <code class="language-plaintext highlighter-rouge">node-gyp</code> we need an additional build time dependency on <code class="language-plaintext highlighter-rouge">"python"</code> (because GYP depends on Python).</p> <pre data-language="ruby">depends_on "python" =&gt; :build</pre> <p>Also note that such a formula would only be compatible with the same Node major version it originally was compiled with. This means that we need to revision every formula with a Node native addon with every major version bump of the <code class="language-plaintext highlighter-rouge">node</code> formula. To make sure we don’t overlook your formula on a Node major version bump, write a meaningful test which would fail in such a case (being invoked with an ABI-incompatible Node version).</p> <h2 id="installation">Installation</h2> <p>Node modules should be installed to <code class="language-plaintext highlighter-rouge">libexec</code>. This prevents the Node modules from contaminating the global <code class="language-plaintext highlighter-rouge">node_modules</code>, which is important so that npm doesn’t try to manage Homebrew-installed Node modules.</p> <p>In the following we distinguish between two types of Node modules installed using formulae:</p> <ul> <li>formulae for standard Node modules compatible with npm’s global module format which should use <a href="#installing-global-style-modules-with-std_npm_args-to-libexec"><code class="language-plaintext highlighter-rouge">std_npm_args</code></a> (like <a href="https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/a/angular-cli.rb"><code class="language-plaintext highlighter-rouge">angular-cli</code></a> or <a href="https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/w/webpack.rb"><code class="language-plaintext highlighter-rouge">webpack</code></a>)</li> <li>formulae where the <code class="language-plaintext highlighter-rouge">npm install</code> call is not the only required install step (e.g. need to also compile non-JavaScript sources) which have to use <a href="#installing-module-dependencies-locally-with-std_npm_args"><code class="language-plaintext highlighter-rouge">std_npm_args</code></a> (like <a href="https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/e/emscripten.rb"><code class="language-plaintext highlighter-rouge">emscripten</code></a> or <a href="https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/g/grunt-cli.rb"><code class="language-plaintext highlighter-rouge">grunt-cli</code></a>)</li> </ul> <p>What both methods have in common is that they are setting the correct environment for using npm inside Homebrew and are returning the arguments for invoking <code class="language-plaintext highlighter-rouge">npm install</code> for their specific use cases. This includes fixing an important edge case with the npm cache (caused by Homebrew’s redirection of <code class="language-plaintext highlighter-rouge">HOME</code> during the build and test process) by using our own custom <code class="language-plaintext highlighter-rouge">npm_cache</code> inside <code class="language-plaintext highlighter-rouge">HOMEBREW_CACHE</code>, which would otherwise result in very long build times and high disk space usage.</p> <h3 id="installing-global-style-modules-with-std_npm_args-to-libexec">Installing global style modules with <code class="language-plaintext highlighter-rouge">std_npm_args</code> to <code class="language-plaintext highlighter-rouge">libexec</code>
</h3> <p>In your formula’s <code class="language-plaintext highlighter-rouge">install</code> method, simply <code class="language-plaintext highlighter-rouge">cd</code> to the top level of your Node module if necessary and then use <code class="language-plaintext highlighter-rouge">system</code> to invoke <code class="language-plaintext highlighter-rouge">npm install</code> with <code class="language-plaintext highlighter-rouge">std_npm_args</code> like:</p> <pre data-language="ruby">system "npm", "install", *std_npm_args</pre> <p>This will install your Node module in npm’s global module style with a custom prefix to <code class="language-plaintext highlighter-rouge">libexec</code>. All your modules’ executables will be automatically resolved by npm into <code class="language-plaintext highlighter-rouge">libexec/bin</code> for you, which are not symlinked into Homebrew’s prefix. To make sure these are installed, we need to symlink all executables to <code class="language-plaintext highlighter-rouge">bin</code> with:</p> <pre data-language="ruby">bin.install_symlink Dir["#{libexec}/bin/*"]</pre> <h3 id="installing-module-dependencies-locally-with-std_npm_args">Installing module dependencies locally with <code class="language-plaintext highlighter-rouge">std_npm_args</code>
</h3> <p>In your formula’s <code class="language-plaintext highlighter-rouge">install</code> method, do any installation steps which need to be done before the <code class="language-plaintext highlighter-rouge">npm install</code> step and then <code class="language-plaintext highlighter-rouge">cd</code> to the top level of the included Node module. Then, use <code class="language-plaintext highlighter-rouge">system</code> to invoke <code class="language-plaintext highlighter-rouge">npm install</code> with <code class="language-plaintext highlighter-rouge">std_npm_args(prefix: false)</code> like:</p> <pre data-language="ruby">system "npm", "install", *std_npm_args(prefix: false)</pre> <p>This will install all of your Node modules’ dependencies to your local build path. You can now continue with your build steps and handle the installation into the Homebrew prefix on your own, following the <a href="formula-cookbook">general Homebrew formula instructions</a>.</p> <h2 id="example">Example</h2> <p>Installing a standard Node module based formula would look like this:</p> <pre data-language="ruby">class Foo &lt; Formula
  desc "An example formula"
  homepage "https://example.com"
  url "https://registry.npmjs.org/foo/-/foo-1.4.2.tgz"
  sha256 "abc123abc123abc123abc123abc123abc123abc123abc123abc123abc123abc1"

  depends_on "node"
  # uncomment if there is a native addon inside the dependency tree
  # depends_on "python" =&gt; :build

  def install
    system "npm", "install", *std_npm_args
    bin.install_symlink Dir["#{libexec}/bin/*"]
  end

  test do
    # add a meaningful test here, version isn't usually meaningful
    assert_match version.to_s, shell_output("#{bin}/foo --version")
  end
end</pre> <h2 id="tooling">Tooling</h2> <p>You can use <a href="https://github.com/zmwangx/homebrew-npm-noob">homebrew-npm-noob</a> to automatically generate a formula like the example above for an npm package.</p><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2009&ndash;present Homebrew contributors<br>Licensed under the BSD 2-Clause License.<br>
    <a href="https://docs.brew.sh/Node-for-Formula-Authors" class="_attribution-link">https://docs.brew.sh/Node-for-Formula-Authors</a>
  </p>
</div>
