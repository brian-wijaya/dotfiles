<h1 id="reproducible-builds">Reproducible Builds</h1> <p>The Homebrew build environment is designed with <a href="https://reproducible-builds.org/">reproducible builds</a> as a goal where possible. Some convenience tools are also available to formula authors to help achieve deterministic builds.</p> <h2 id="build-time">Build time</h2> <p>Some build tools embed or record the time at which the build occurs. This can cause build artifacts to differ between repeated builds of the same sources. To avoid this issue, the Homebrew build environment sets the <a href="https://reproducible-builds.org/docs/source-date-epoch/"><code class="language-plaintext highlighter-rouge">SOURCE_DATE_EPOCH</code> environment variable</a> to the modification time of the source code for tools that consume it.</p> <p>In cases where a build time must be manually set, <code class="language-plaintext highlighter-rouge">time</code> is a Ruby <code class="language-plaintext highlighter-rouge">DateTime</code> object containing the same timestamp as the <code class="language-plaintext highlighter-rouge">SOURCE_DATE_EPOCH</code> environment variable. Methods provided by Ruby on <code class="language-plaintext highlighter-rouge">DateTime</code> objects can then be used to format this time into the desired format.</p> <pre data-language="ruby">def install
  system "make", "install",
         "VERSION=#{version}",
         "DATE=#{time.iso8601}",
         "PREFIX=#{prefix}"
end</pre> <p>See the <a href="https://github.com/Homebrew/homebrew-core/blob/442f9cc511ce6dfe75b96b2c83749d90dde914d2/Formula/k/kustomize.rb#L32"><code class="language-plaintext highlighter-rouge">kustomize</code></a> formula for an example of using <code class="language-plaintext highlighter-rouge">time.iso8601</code> or the <a href="https://github.com/Homebrew/homebrew-core/blob/442f9cc511ce6dfe75b96b2c83749d90dde914d2/Formula/g/git-town.rb#L25"><code class="language-plaintext highlighter-rouge">git-town</code></a> formula for an example of using <code class="language-plaintext highlighter-rouge">time.strftime</code> with custom format specifiers.</p> <h2 id="reproducible-gzip-compression">Reproducible gzip compression</h2> <p>Some formulae may create gzip-compressed files during their build process (for example, compressing manpages or other data files). Build machines may provide different implementations of the <code class="language-plaintext highlighter-rouge">gzip</code> utility, and by default <code class="language-plaintext highlighter-rouge">gzip</code> will record the modification time of the file being compressed, which usually varies depending on the build time. Thus, relying on the build machine’s <code class="language-plaintext highlighter-rouge">gzip</code> utility will usually result in non-reproducible outputs being part of the build.</p> <p>To avoid this issue, Homebrew provides the <code class="language-plaintext highlighter-rouge">Utils::Gzip.compress</code> helper function for situations where reproducible <code class="language-plaintext highlighter-rouge">gzip</code> compression is needed. This function accepts one or more paths to be compressed and places the compressed files next to the original with a <code class="language-plaintext highlighter-rouge">.gz</code> suffix, just like the <code class="language-plaintext highlighter-rouge">gzip</code> utility does. It also returns an array of <code class="language-plaintext highlighter-rouge">Pathname</code> objects which can be consumed by other methods.</p> <pre data-language="ruby">def install
  system "make", "install"
  man1.install Utils::Gzip.compress("mycommand.1")
end</pre> <pre data-language="ruby">def install
  system "make", "install"
  (pkgshare/"data").install Utils::Gzip.compress(*Dir["#{buildpath}/path/to/some/folder/contents/*"])
end</pre> <p>See the <a href="https://github.com/Homebrew/homebrew-core/blob/442f9cc511ce6dfe75b96b2c83749d90dde914d2/Formula/p/par.rb#L30"><code class="language-plaintext highlighter-rouge">par</code> formula</a> for an example with a single file or the <a href="https://github.com/Homebrew/homebrew-core/blob/442f9cc511ce6dfe75b96b2c83749d90dde914d2/Formula/p/pari-elldata.rb#L28"><code class="language-plaintext highlighter-rouge">pari-elldata</code> formula</a> for an example with multiple files.</p> <h2 id="relocatability">Relocatability</h2> <p>Some formulae or build tools record paths specific to the build environment in configuration files or in binaries. When building redistributable bottles, Homebrew searches through the built files and replaces paths to common Homebrew locations, such as the Homebrew prefix and the Cellar, with a placeholder like <code class="language-plaintext highlighter-rouge">@@HOMEBREW_PREFIX@@</code> or <code class="language-plaintext highlighter-rouge">@@HOMEBREW_CELLAR@@</code>. When bottles are installed, Homebrew expands these placeholders to the respective paths on the end user’s machine.</p> <p>This allows for some bottles to be used by users that may have Homebrew installed in a non-default prefix. It also results in bit-for-bit identical bottles between platforms where the location of Homebrew is the only difference.</p> <p>This search and replace process occurs automatically and does not require any additional action from formula authors to use it.</p><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2009&ndash;present Homebrew contributors<br>Licensed under the BSD 2-Clause License.<br>
    <a href="https://docs.brew.sh/Reproducible-Builds" class="_attribution-link">https://docs.brew.sh/Reproducible-Builds</a>
  </p>
</div>
