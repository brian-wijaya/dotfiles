#!/usr/bin/env python3
"""Set up Dropbox with refresh token for long-lived access.

Run once: python dropbox-auth.py
Then use get_dropbox_client() in other scripts.
"""

import json
from pathlib import Path

APP_KEY = "YOUR_APP_KEY"  # From Dropbox app console
APP_SECRET = "YOUR_APP_SECRET"  # From Dropbox app console (click "Show")

CONFIG_FILE = Path.home() / ".config" / "dropbox-oauth.json"

def setup():
    """Interactive setup to get refresh token."""
    import dropbox
    from dropbox import DropboxOAuth2FlowNoRedirect

    auth_flow = DropboxOAuth2FlowNoRedirect(
        APP_KEY,
        APP_SECRET,
        token_access_type='offline'  # This gives us a refresh token
    )

    authorize_url = auth_flow.start()
    print("1. Go to:", authorize_url)
    print("2. Click 'Allow' (you may need to log in)")
    print("3. Copy the authorization code")
    auth_code = input("Enter the code: ").strip()

    oauth_result = auth_flow.finish(auth_code)

    config = {
        "app_key": APP_KEY,
        "app_secret": APP_SECRET,
        "refresh_token": oauth_result.refresh_token,
    }

    CONFIG_FILE.parent.mkdir(parents=True, exist_ok=True)
    CONFIG_FILE.write_text(json.dumps(config, indent=2))
    CONFIG_FILE.chmod(0o600)

    print(f"\nSaved to {CONFIG_FILE}")
    print("Refresh token never expires - it will auto-renew access tokens.")

def get_dropbox_client():
    """Get Dropbox client with auto-refreshing token."""
    import dropbox

    if not CONFIG_FILE.exists():
        raise FileNotFoundError(f"Run 'python dropbox-auth.py' first to set up OAuth")

    config = json.loads(CONFIG_FILE.read_text())

    return dropbox.Dropbox(
        app_key=config["app_key"],
        app_secret=config["app_secret"],
        oauth2_refresh_token=config["refresh_token"]
    )

if __name__ == "__main__":
    print("Dropbox OAuth Setup")
    print("=" * 40)
    print(f"\nFirst, update APP_KEY and APP_SECRET in this file.")
    print("Find them at: https://www.dropbox.com/developers/apps")
    print("  - APP_KEY: App key (visible)")
    print("  - APP_SECRET: App secret (click 'Show')")
    print()

    if APP_KEY == "YOUR_APP_KEY":
        print("ERROR: Edit this file and add your APP_KEY and APP_SECRET first!")
    else:
        setup()
