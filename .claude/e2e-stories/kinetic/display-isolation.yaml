# Kinetic Display Isolation — Stories and Constraints
# Xvfb-based display isolation for autonomous GUI operation

vocabulary:
  display-session: Kinetic-managed lifecycle construct wrapping an Xvfb instance, window manager, and GUI applications. Disposable infrastructure — kill and recreate on config change.
  agent-display: The Xvfb X server (e.g., :99) where Claude performs all GUI operations. Fully real, pixel-based, invisible unless inspected via xpra.
  human-display: The host X server (:0) where the human works. Claude observes this via somatic but never acts on it.
  xpra-bridge: Optional read-only observation layer. Attaches to a running Xvfb session for inspection, detaches without disruption. Not the display server itself.
  display-routing: Kinetic routes action tools to agent's display, somatic senses all displays. The display is an environment variable, not a tool API change.

metadata:
  feature: kinetic
  component: display-isolation
  tags: [kinetic, xvfb, display, isolation, gui, playwright]

stories:
  # === LIFECYCLE ===

  - name: create-display-session
    description: >
      Kinetic creates a DisplaySession by launching Xvfb with explicit geometry (3440x1440),
      24-bit color depth, and deterministic DPI. The display number is assigned and immutable
      for the session lifetime.
    preconditions:
      - kinetic running
      - Xvfb installed
    steps:
      - kinetic: DisplaySession.create(geometry="3440x1440x24", dpi=96)
    verify:
      - Xvfb process running on assigned display number
      - DISPLAY and XAUTHORITY set for the session
      - no connection to human's display (:0)

  - name: launch-window-manager
    description: >
      After Xvfb starts, kinetic launches a minimal window manager (i3) inside the
      display session. The WM inherits DISPLAY from the session.
    preconditions:
      - DisplaySession created with running Xvfb
    steps:
      - kinetic: DisplaySession.start() — launches i3 inside Xvfb
    verify:
      - i3 process running with DISPLAY=:99 (or assigned number)
      - i3 does not connect to :0

  - name: launch-gui-application
    description: >
      Kinetic launches target applications (Emacs, terminals) inside the display session.
      All GUI processes inherit DISPLAY and XAUTHORITY from the session. No process
      may connect to the host display server.
    preconditions:
      - DisplaySession started with WM running
    steps:
      - kinetic: launch Emacs inside display session
    verify:
      - Emacs process running with correct DISPLAY
      - Emacs window visible in Xvfb (verifiable via screenshot)
      - Emacs does not connect to :0

  - name: xpra-attach-observe
    description: >
      xpra attaches to a running Xvfb session for human observation. Connection is
      read-only by default. The agent's session continues uninterrupted.
    preconditions:
      - DisplaySession running with applications
    steps:
      - kinetic: DisplaySession.attachViewer()
    verify:
      - xpra viewer shows the agent's display
      - agent's GUI operations continue without interruption
      - viewer is read-only (no input forwarding by default)

  - name: xpra-detach-clean
    description: >
      xpra detaches from the display session without disrupting the agent. The
      agent's applications continue running. No state change.
    preconditions:
      - xpra viewer attached to display session
    steps:
      - kinetic: DisplaySession.detachViewer()
    verify:
      - xpra viewer disconnected
      - agent's applications unaffected
      - display session state unchanged

  - name: destroy-display-session
    description: >
      Kinetic destroys a display session by killing all child processes (applications,
      WM, Xvfb) and freeing the display number. Session is gone.
    preconditions:
      - DisplaySession running
    steps:
      - kinetic: DisplaySession.destroy()
    verify:
      - all child processes terminated (Emacs, i3, Xvfb)
      - display number freed
      - no orphan processes

  - name: restart-on-config-change
    description: >
      Any change to display-level configuration (resolution, DPI, color depth)
      requires destroying and recreating the entire DisplaySession. Emacs and
      other applications cannot migrate between display servers at runtime.
    preconditions:
      - DisplaySession running with applications
    steps:
      - kinetic: change resolution to 1920x1080
    verify:
      - old session destroyed (all processes killed)
      - new session created with new resolution
      - applications relaunched from scratch

  # === TOOL ROUTING ===

  - name: actions-route-to-agent-display
    description: >
      All x11 action tools (x11_key, x11_click, x11_type, x11_mouse_move) and
      emacs tools (emacs_elisp, emacs_key, emacs_navigate) route to the agent's
      Xvfb display by default. Kinetic sets DISPLAY in the process environment.
      No tool API changes.
    preconditions:
      - DisplaySession running
    steps:
      - kinetic: x11_key("Return") — routed to :99
      - kinetic: emacs_elisp("(buffer-name)") — routed to agent's Emacs
    verify:
      - key event delivered to agent's display, not human's
      - emacs command executed in agent's Emacs instance

  - name: somatic-senses-all-displays
    description: >
      Somatic connects to all registered displays (human's :0, agent's :99, additional
      agent displays if running teams). Single somatic process, multiple X11 connections.
      All events tagged with source display. Per-display dedicated ring buffers.
    preconditions:
      - somatic running
      - at least one display session active
    steps:
      - somatic: register agent display :99
      - trigger events on both :0 and :99
    verify:
      - events from :0 tagged with display=:0
      - events from :99 tagged with display=:99
      - separate ring buffers per display, no cross-eviction

  - name: no-action-on-human-display
    description: >
      Claude never acts on the human's display (:0). All GUI actions go to the
      agent's display. If Claude observes a dialog on the human's screen via
      somatic, it advises — it does not click.
    preconditions:
      - DisplaySession running
      - somatic sensing human's display
    steps:
      - Claude observes dialog on human's display via somatic
    verify:
      - Claude provides advisory text ("I see a dialog asking about X")
      - no x11_click, x11_key, or other action tool targets :0

  # === MULTI-AGENT ===

  - name: multiple-display-sessions
    description: >
      Multiple agent sessions can run simultaneously, each with its own Xvfb.
      Useful for agent teams where each agent operates its own GUI environment.
      Displays are :99, :100, :101, etc.
    preconditions:
      - kinetic running
      - agent team with multiple agents
    steps:
      - kinetic: create DisplaySession for agent-1 (:99)
      - kinetic: create DisplaySession for agent-2 (:100)
    verify:
      - two Xvfb processes on different display numbers
      - each agent's tools route to its own display
      - somatic senses both agent displays

enforced_constraints:
  - name: display-isolation-hard-boundary
    description: >
      Agent GUI processes MUST NOT connect to the human's display (:0).
      DISPLAY and XAUTHORITY are set per-session. This is a hard arbitration
      boundary for cursor ownership and keyboard focus.
    rationale: >
      The entire point of display isolation is eliminating input contention.
      Any leak from agent to human's display reintroduces the problem.
      Enforcement: all child processes inherit session environment, never host environment.

  - name: no-agent-action-on-human-display
    description: Claude never sends input events (key, click, type, mouse) to the human's display
    rationale: >
      The human's display is sense-only via somatic. Actions go to the agent's
      display exclusively. This is the fundamental asymmetry: sense everything,
      act only in your own sandbox.

  - name: display-session-disposable
    description: Any display-level config change requires full session destruction and recreation
    rationale: >
      X11 applications cannot migrate between display servers at runtime. Emacs
      opens a connection to one X server at startup and cannot reconnect. Treat
      display sessions as disposable infrastructure — cheap to create, cheap to destroy.

  - name: somatic-senses-all-displays
    description: >
      Somatic is the sensory system for ALL displays, not just the human's.
      Single somatic process, multiple X11 connections. Command is not outcome —
      Claude must sense the result of its own actions, not assume them.
    rationale: >
      Just because Claude sent a keystroke to its Emacs doesn't mean the expected
      result occurred. Programs have bugs, dialogs appear, errors happen. Somatic
      verifies outcomes by sensing the actual display state after every action.

opinionated_constraints:
  - name: xvfb-default-backend
    description: Xvfb is the display backend, not Xephyr or Xwayland. Chosen at startup, immutable for session lifetime.
    rationale: >
      Xvfb is headless by design, battle-tested for CI/CD, zero GPU requirements.
      Xephyr nests inside an existing display (reintroduces coupling). Xwayland
      adds Wayland complexity with no benefit for a headless agent.

  - name: xpra-read-only-default
    description: xpra observation is read-only by default. Input forwarding requires explicit opt-in and agent pause.
    rationale: >
      Read-only observation preserves isolation. Input forwarding reintroduces
      contention within the agent's display. If the human needs to interact,
      they attach with input explicitly and Claude pauses operations.

  - name: no-container-isolation
    description: No container or mount namespace isolation. Filesystem is shared intentionally.
    rationale: >
      The shared filesystem IS the bridge between displays. Claude saves a file
      in its Xvfb Emacs, the file appears on disk, the human sees it. Container
      isolation would break this bridge. The input contention problem is already
      solved by display isolation — containers add complexity with no benefit.

  - name: processbuilder-orchestration
    description: All display process management via Java ProcessBuilder, not native code or JNI
    rationale: >
      Xvfb, i3, Emacs, xpra are OS processes. Kinetic manages their lifecycle
      via ProcessBuilder. No JNI, no Panama FFI for display management. Process
      management is not a performance-critical path — startup happens once.

  - name: single-somatic-multi-display
    description: One somatic daemon connects to all displays, not one daemon per display
    rationale: >
      Simpler to operate (one systemd unit, one config). Better performance
      (shared memory, single event loop). If it crashes, you fix it either way —
      crash isolation between instances is a phantom benefit.

  - name: playwright-model
    description: >
      Conceptually aligned with Playwright's browser model: deterministic viewport,
      isolated input domain, programmatic control, optional inspection. Applied to
      desktop UIs instead of browsers.
    rationale: >
      Playwright is the existence proof that sandbox-first automation works.
      Same properties apply: reproducible environment, no interference with
      the user's session, full programmatic control, attach viewer when needed.

  - name: stage-3-build-order
    description: >
      Display isolation is Stage 3 work — after core kinetic (Stage 1) and
      server absorptions (Stage 2). It doesn't block anything before it and
      benefits from x11 tool absorption being stable first.
    rationale: >
      The x11 tools are what Claude uses inside the Xvfb display. They must
      work correctly before display isolation adds value. Core kinetic (MCP
      gateway, somatic proxy) must exist before display sessions can be managed.
