# Sensor X11 Event Bus Server E2E Tests

vocabularies: [sensor, services]

metadata:
  feature: sensor
  component: core-x11-bus
  tags: [sensor, core]
  estimated_duration_ms: 5000

stories:
  - name: x11-bus-running
    description: X11 event bus server is active
    steps:
      - service_active: sensor-x11-bus
      - sensor_get_status
    verify:
      - Contains: "x11_bus"

  - name: x11-event-capture
    description: X11 events are captured from the bus
    steps:
      - bash: "xdotool mousemove 300 300"
      - bash: "sleep 0.2"
      - sensor_get_events
    verify:
      - Contains: "MotionNotify"

  - name: x11-event-subscription
    description: Clients can subscribe to X11 events
    steps:
      - sensor_subscribe
      - bash: "xdotool type 'test'"
      - bash: "sleep 0.2"
      - sensor_get_latest
    verify:
      - Contains: "KeyPress"

  - name: x11-change-subscription
    description: Window change events are tracked
    steps:
      - sensor_subscribe_changes
      - bash: "xdotool search --name 'emacs' windowactivate || true"
      - bash: "sleep 0.3"
      - sensor_get_latest
    verify:
      - Contains: "FocusIn"

  - name: x11-event-filtering
    description: X11 events can be filtered by type
    steps:
      - bash: "sensor-cli x11-bus --filter KeyPress --json | jq 'length'"
    verify:
      - Greater: 0

  - name: x11-bus-statistics
    description: X11 bus statistics are tracked
    steps:
      - sensor_get_stats
    verify:
      - Contains: "events_processed"
      - Contains: "subscribers"

  - name: x11-connection-health
    description: X11 connection health is monitored
    steps:
      - bash: "sensor-cli x11-bus --health --json | jq -r '.connected'"
    verify:
      - Equals: "true"
