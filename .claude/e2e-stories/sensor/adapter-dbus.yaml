# Sensor D-Bus Adapter E2E Tests

vocabularies: [sensor, services]

metadata:
  feature: sensor
  component: adapter-dbus
  tags: [sensor, core]
  estimated_duration_ms: 5000

stories:
  - name: dbus-adapter-running
    description: D-Bus adapter service is active
    steps:
      - service_active: sensor-dbus-adapter
      - sensor_get_status
    verify:
      - Contains: "dbus"

  - name: dbus-message-posting
    description: Messages can be posted to D-Bus
    steps:
      - sensor_post_message
      - bash: "sleep 0.2"
      - bash: "sensor-cli dbus --list-messages --json | jq 'length'"
    verify:
      - Greater: 0

  - name: dbus-signal-emission
    description: D-Bus signals are emitted for events
    steps:
      - bash: "xdotool type 'test'"
      - bash: "sleep 0.3"
      - bash: "sensor-cli dbus --signals --json | jq '.sensor_events | length'"
    verify:
      - Greater: 0

  - name: dbus-method-exposure
    description: Sensor methods are exposed via D-Bus
    steps:
      - bash: "dbus-send --session --print-reply --dest=com.sensor / org.freedesktop.DBus.Introspectable.Introspect || true"
    verify:
      - Contains: "method"

  - name: dbus-property-access
    description: Sensor properties accessible via D-Bus
    steps:
      - bash: "sensor-cli dbus --get-property status --json | jq -r '.value'"
    verify:
      - NotEmpty

  - name: dbus-adapter-status
    description: D-Bus adapter status is queryable
    steps:
      - bash: "sensor-cli dbus --adapter-status --json | jq -r '.connected'"
    verify:
      - Equals: "true"
