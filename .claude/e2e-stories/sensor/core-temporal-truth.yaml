# Sensor Temporal Consistency/Truth Server E2E Tests

vocabularies: [sensor, services]

metadata:
  feature: sensor
  component: core-temporal-truth
  tags: [sensor, core]
  estimated_duration_ms: 5000

stories:
  - name: temporal-truth-service-running
    description: Temporal consistency server is active
    steps:
      - service_active: sensor-temporal-truth
      - sensor_get_status
    verify:
      - Contains: "temporal"

  - name: event-ordering-validation
    description: Event ordering is validated
    steps:
      - bash: "xdotool type 'abc'"
      - bash: "sleep 0.3"
      - bash: "sensor-cli temporal --validate-order --json | jq -r '.consistent'"
    verify:
      - Equals: "true"

  - name: timestamp-monotonicity
    description: Timestamps are monotonically increasing
    steps:
      - bash: "sensor-cli temporal --check-monotonic --json | jq -r '.monotonic'"
    verify:
      - Equals: "true"

  - name: causality-tracking
    description: Causal relationships are tracked
    steps:
      - bash: "xdotool type 'test'"
      - bash: "sleep 0.3"
      - bash: "sensor-cli temporal --causality --json | jq '.chains | length'"
    verify:
      - Greater: 0

  - name: time-delta-calculation
    description: Time deltas between events are calculated
    steps:
      - sensor_delta
    verify:
      - Contains: "delta_us"

  - name: temporal-anomaly-detection
    description: Temporal anomalies are detected
    steps:
      - sensor_inject_delay
      - bash: "sleep 0.5"
      - sensor_get_anomalies
    verify:
      - Contains: "temporal"

  - name: clock-skew-detection
    description: Clock skew is detected
    steps:
      - bash: "sensor-cli temporal --check-skew --json | jq -r '.skew_detected'"
    verify:
      - NotEmpty
